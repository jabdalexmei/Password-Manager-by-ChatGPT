
---

# ТЗ FE-STEP2-ARCH-02 — Vault фронтенд по канону + интеграция с backend (полная спецификация)

## 0) Цель

Перевести Vault UI в каноничную архитектуру (components + hooks) и подключить весь функционал к Tauri backend-командам (folders/datacards/settings). В результате Vault перестаёт быть макетом: кнопки работают, данные читаются/создаются/удаляются в `vault.db`.

---

## 1) Ограничения/правила проекта

1. Нельзя использовать `localStorage` и `src/features/Vault/storage.ts` как источник данных для Vault. Любые операции — только через `invoke` команд backend.
2. Нельзя оставлять “мертвые” кнопки без `onClick`. Если кнопка в UI есть — она должна работать или быть убрана.
3. Frontend типы и поля должны соответствовать backend контракту. Нельзя использовать поля, которых нет в backend (например `favorite`, `archived`, `notes`).
4. Ошибки backend должны обрабатываться, особенно `VAULT_LOCKED` → переход в locked flow (возврат на Login/или экран блокировки).
5. На этом этапе **не делать**: импорт/экспорт, генератор паролей, attachments UI, бэкапы UI — только базовый Vault CRUD + Trash списки.

---

## 2) Backend контракт (какие команды существуют и как вызываются)

Использовать `invoke(<command>, payload)`.

### 2.1 Folders

* `list_folders` → `[]`
* `list_deleted_folders` → `[]`
* `create_folder` → `{ input }`
* `rename_folder` → `{ input }`
* `move_folder` → `{ input }`
* `delete_folder` → `{ id }`
* `restore_folder` → `{ id }`
* `purge_folder` → `{ id }`

### 2.2 DataCards

* `list_datacards` → `[]`
* `list_deleted_datacards` → `[]`
* `get_datacard` → `{ id }`
* `create_datacard` → `{ input }`
* `update_datacard` → `{ input }`
* `move_datacard_to_folder` → `{ input }`
* `delete_datacard` → `{ id }`
* `restore_datacard` → `{ id }`
* `purge_datacard` → `{ id }`

### 2.3 Settings

* `get_settings` → `[]`
* `update_settings` → `{ settings }`

---

## 3) Структура файлов (создать/переместить)

Нужно привести Vault к каноничной структуре.

### 3.1 Создать новые файлы

```
src/features/Vault/api/vaultApi.ts

src/features/Vault/types/backend.ts
src/features/Vault/types/ui.ts
src/features/Vault/types/mappers.ts

src/features/Vault/useVault.ts
src/features/Vault/Vault.tsx

src/features/Vault/components/Header/VaultHeader.tsx
src/features/Vault/components/Header/useVaultHeader.ts

src/features/Vault/components/Search/Search.tsx
src/features/Vault/components/Search/useSearch.ts

src/features/Vault/components/Folders/Folders.tsx
src/features/Vault/components/Folders/useFolders.ts

src/features/Vault/components/DataCards/DataCards.tsx
src/features/Vault/components/DataCards/useDataCards.ts

src/features/Vault/components/Details/Details.tsx
src/features/Vault/components/Details/useDetails.ts

src/features/Vault/components/modals/CreateFolderModal.tsx
src/features/Vault/components/modals/CreateDataCardModal.tsx
src/features/Vault/components/modals/EditDataCardModal.tsx

src/features/Vault/components/Trash/TrashToggle.tsx
```

### 3.2 Удалить или полностью отключить

* `src/features/Vault/storage.ts` — удалить файл **или** гарантировать 0 импортов.
* Любые импорты из `./storage` должны исчезнуть.

---

## 4) Типы и маппинг (чтобы не словить несовместимость snake_case/camelCase)

### 4.1 `src/features/Vault/types/backend.ts` (строго snake_case)

Определить интерфейсы по backend:

```ts
export type BackendFolder = {
  id: string;
  name: string;
  parent_id: string | null;
  is_system: boolean;
  created_at: string;
  updated_at: string;
  deleted_at: string | null;
};

export type BackendBankCard = {
  holder: string;
  number: string;
  expiry_mm_yy: string;
  cvc: string;
  note: string | null;
};

export type BackendCustomFieldType = "text" | "secret" | "url" | "number" | "date";

export type BackendCustomField = {
  key: string;
  value: string;
  type: BackendCustomFieldType;
};

export type BackendDataCard = {
  id: string;
  folder_id: string | null;

  title: string;
  url: string | null;
  email: string | null;
  username: string | null;
  mobile_phone: string | null;
  note: string | null;
  tags: string[];

  created_at: string;
  updated_at: string;
  deleted_at: string | null;

  password: string | null;
  bank_card: BackendBankCard | null;
  custom_fields: BackendCustomField[];
};

export type BackendUserSettings = {
  auto_hide_secret_timeout_seconds: number;
  auto_lock_enabled: boolean;
  auto_lock_timeout: number;
  reveal_requires_confirmation: boolean;

  clipboard_clear_timeout_seconds: number;

  soft_delete_enabled: boolean;
  trash_retention_days: number;

  backups_enabled: boolean;
  backup_frequency: "daily" | "weekly" | "monthly";
  backup_retention_days: number;

  default_sort_field: "created_at" | "updated_at" | "title";
  default_sort_direction: "ASC" | "DESC";

  mask_password_by_default: boolean;
};
```

### 4.2 `src/features/Vault/types/ui.ts`

UI типы можно сделать camelCase (рекомендуется). Минимум:

```ts
export type Folder = {
  id: string;
  name: string;
  parentId: string | null;
  isSystem: boolean;
  createdAt: string;
  updatedAt: string;
  deletedAt: string | null;
};

export type CustomFieldType = "text" | "secret" | "url" | "number" | "date";

export type CustomField = {
  key: string;
  value: string;
  type: CustomFieldType;
};

export type BankCard = {
  holder: string;
  number: string;
  expiryMmYy: string;
  cvc: string;
  note: string | null;
};

export type DataCard = {
  id: string;
  folderId: string | null;
  title: string;
  url: string | null;
  email: string | null;
  username: string | null;
  mobilePhone: string | null;
  note: string | null;
  tags: string[];
  createdAt: string;
  updatedAt: string;
  deletedAt: string | null;
  password: string | null;
  bankCard: BankCard | null;
  customFields: CustomField[];
};
```

### 4.3 `src/features/Vault/types/mappers.ts`

Добавить маппинг:

* `mapFolderFromBackend(BackendFolder) -> Folder`
* `mapCardFromBackend(BackendDataCard) -> DataCard`
* `mapCreateCardToBackend(input: { ...UI fields... }) -> CreateDataCardInput`
* `mapUpdateCardToBackend(input) -> UpdateDataCardInput`

**Важно:** payload в `invoke` должен быть **в snake_case** как backend ждёт.

---

## 5) API слой для Vault (единая точка invoke)

### 5.1 `src/features/Vault/api/vaultApi.ts`

Реализовать функции:

Folders:

* `listFolders(): Promise<BackendFolder[]>`
* `listDeletedFolders(): Promise<BackendFolder[]>`
* `createFolder(input: { name: string; parent_id: string | null }): Promise<BackendFolder>`
* `renameFolder(input: { id: string; name: string }): Promise<boolean>`
* `moveFolder(input: { id: string; parent_id: string | null }): Promise<boolean>`
* `deleteFolder(id: string): Promise<boolean>`
* `restoreFolder(id: string): Promise<boolean>`
* `purgeFolder(id: string): Promise<boolean>`

DataCards:

* `listDataCards(): Promise<BackendDataCard[]>`
* `listDeletedDataCards(): Promise<BackendDataCard[]>`
* `getDataCard(id: string): Promise<BackendDataCard>`
* `createDataCard(input: anySnakeCase): Promise<BackendDataCard>`
* `updateDataCard(input: anySnakeCase): Promise<boolean>`
* `moveDataCardToFolder(input: { id: string; folder_id: string | null }): Promise<boolean>`
* `deleteDataCard(id: string): Promise<boolean>`
* `restoreDataCard(id: string): Promise<boolean>`
* `purgeDataCard(id: string): Promise<boolean>`

Settings:

* `getSettings(): Promise<BackendUserSettings>`
* `updateSettings(settings: BackendUserSettings): Promise<BackendUserSettings | boolean>` (смотреть фактический return; если backend возвращает `UserSettings` — принять, если bool — принять bool)

---

## 6) Оркестратор `useVault.ts` (центральное состояние + действия)

### 6.1 Файл: `src/features/Vault/useVault.ts`

Хук должен хранить:

Состояние:

* `folders: Folder[]`
* `cards: DataCard[]`
* `deletedFolders: Folder[]` (загружать лениво при переключении в Trash)
* `deletedCards: DataCard[]` (загружать лениво)
* `selectedFolderId: string | null`
* `selectedCardId: string | null`
* `searchQuery: string`
* `isTrashMode: boolean`
* `settings: BackendUserSettings | null`
* `loading: boolean`
* `error: { code: string; message?: string } | null`

Действия:

* `refreshActive()` → грузит folders + cards
* `refreshTrash()` → грузит deleted folders + deleted cards
* `toggleTrashMode(on: boolean)` → включает режим + грузит нужные списки
* Folder actions:

  * `createFolder(name, parentId)`
  * `renameFolder(id, name)`
  * `deleteFolder(id)`
  * `restoreFolder(id)`
  * `purgeFolder(id)`
* Card actions:

  * `createCard(payloadUI)` → map → backend create
  * `updateCard(payloadUI)` → map → backend update
  * `deleteCard(id)`
  * `restoreCard(id)`
  * `purgeCard(id)`
  * `moveCardToFolder(id, folderId)`
* `lock()` → вызывает tauri `lock_vault` (существующая команда), очищает стейты, переводит UI в locked flow.

Обработка ошибок:

* если backend вернул ошибку с `code === "VAULT_LOCKED"`:

  * вызвать `onLocked()` из props (или callback) → UI уходит в Login.
* остальное → сохранить в `error` и показать toast/inline (минимум: `console.error` допустим на этом шаге).

Фильтрация:

* `searchQuery` фильтрует список карточек по `title`, `username`, `email`, `url`, `tags`.
* Фильтрация выполняется на фронте (пока нет backend search).

---

## 7) UI компоненты и обязательные обработчики

### 7.1 `src/features/Vault/Vault.tsx`

Это layout: три колонки + header:

* Header
* Sidebar folders
* Cards list
* Details pane

`Vault.tsx` получает из `useVault()`:

* данные
* экшены
* selected ids
* toggleTrash

### 7.2 `VaultHeader.tsx`

Должно быть минимум:

* кнопка Lock → `onLock()`
* toggle Trash → `onToggleTrash()`
* (опционально) отображение профиля/статуса

### 7.3 `Folders.tsx`

Должно быть:

* список папок (или deletedFolders при trash mode)
* кнопка Add Folder → открывает `CreateFolderModal`
* delete folder кнопка возле элемента (если не system)
* при trash mode: кнопки `Restore` и `Purge` возле папки

### 7.4 `DataCards.tsx`

Должно быть:

* список карточек (или deletedCards при trash mode)
* кнопка Add Data Card → `CreateDataCardModal`
* delete card возле карточки
* при trash mode: `Restore/Purge`

### 7.5 `Details.tsx`

Должно быть:

* отображение выбранной карточки
* кнопка Edit → `EditDataCardModal`
* кнопка Delete → `deleteCard`
* (опционально) кнопка Move → выбрать папку (можно позже; минимум допускается перенос без UI)

---

## 8) Модалки (минимальный функционал)

### 8.1 CreateFolderModal

Поля:

* `name` (required)
* parentId не нужен (пока корень)

При confirm:

* `createFolder(name, null)`

### 8.2 CreateDataCardModal

Поля (минимум):

* `title` (required)
* `username` (optional)
* `email` (optional)
* `password` (optional)
* `url` (optional)
* `note` (optional)
* `tags` (optional, через input “tag1, tag2”)

Payload map в backend snake_case:

* `folder_id` = выбранная папка или null
* `custom_fields` = []
* `bank_card` = null

### 8.3 EditDataCardModal

То же, но редактирует существующую карточку.
Payload update в backend должен включать `id`.

---

## 9) Удалить поля и UI, которых нет в backend

Обязательно убрать из Vault UI (если они есть):

* Favorite
* Archive
* Любые toggle/иконки под это
* Поле `notes` заменить на `note`

---

## 10) Критерии приёмки (строгие)

После входа в Vault:

1. **Folders**

* Add Folder создаёт папку → появляется в списке без перезапуска.
* Delete folder переносит папку в Trash → исчезает из активного списка.
* В Trash: Restore возвращает папку.
* В Trash: Purge удаляет папку навсегда.

2. **DataCards**

* Add Data Card создаёт карточку → появляется в списке.
* Выбор карточки показывает Details.
* Edit меняет title/note → видно сразу после сохранения.
* Delete убирает карточку из активных.
* В Trash: Restore/Purge работают.

3. **Lock**

* Нажатие Lock вызывает `lock_vault`
* После Lock любая попытка refresh ловит `VAULT_LOCKED` и UI возвращается в Login/locked flow.

4. **Отсутствие моков**

* В проекте нет импортов `src/features/Vault/storage.ts`
* Никакие данные Vault не сохраняются в `localStorage`.

---

## 11) Примечания по совместимости

* Backend возвращает `snake_case`. Если UI работает в camelCase — мапперы обязательны.
* Если после перехода JSON-формата (bank_card/custom_fields) есть старые данные в `vault.db`, тестировать на новом профиле.

---

