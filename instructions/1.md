
## Technical Specification (EN): Attach files during “Create data card” + Open attachments from “Information” (Tauri v2)

### Goal

Implement:

* Selecting and attaching one or more files while creating a new Data Card (Create modal).
* Viewing attachments from the Information (Details) panel by opening them in the OS default application (“Open” action).
* Ensure decrypted attachment previews are not left on disk after locking the vault / app exit.

### Non-goals

* Inline preview inside the UI (PDF/image renderer) is out of scope. “Preview” == open with default OS app.
* Backward compatibility with old profiles is out of scope (per user requirement).
* Changing encryption/KDF logic is out of scope for this ticket.

---

## UX / UI Requirements

### A) Create Data Card modal

Location: bottom area of the modal (under Tags field, above footer buttons) — as per provided mock.

Required behavior:

1. Add a button **“Add file”** (paperclip-style UI).
2. Clicking “Add file” opens the native file picker (Tauri v2 dialog plugin).
3. Allow selecting **multiple files** in one picker open.
4. Show a list of selected files (at least filename; optional: size if easily available).
5. Allow removing a selected file from the list before creation.
6. On “Create” submit:

   * Create the Data Card first.
   * If created successfully, upload all selected files as attachments for the created card.
   * If some uploads fail: show an error toast per failed file (or one aggregated toast) but continue uploading remaining files.
   * After upload completes, clear the pending list and close modal.

### B) Information (Details) panel attachments section

Current UI exists and shows: name + size + remove button.

Extend behavior:

1. Each attachment row must include an **“Open”** action (button or clickable row).
2. “Open” must:

   * create a decrypted preview file in a temp folder under the profile directory
   * open it via Tauri opener plugin (Rust side)
3. Keep existing “Remove” behavior unchanged.
4. “Add file” in Details can remain (already exists) but must use Tauri v2 dialog plugin import (`@tauri-apps/plugin-dialog`) (frontend).

---

## Dependency / Plugin requirements (Tauri v2)

### Dialog plugin (frontend usage)

Frontend must import `open` from `@tauri-apps/plugin-dialog`.
This project currently has Rust plugin (`tauri-plugin-dialog`) enabled in `src-tauri/src/main.rs`, but JS dependency is missing.

### Opener plugin (for opening decrypted preview files)

Use Tauri v2 opener plugin for opening files in the default application.

---

## Backend Changes (Rust)

### 1) Add opener plugin dependency and initialization

**File:** `src-tauri/Cargo.toml`
Add dependency:

```toml
tauri-plugin-opener = "2.0.0"
```

**File:** `src-tauri/src/main.rs`
In `tauri::Builder::default()` chain add:

```rust
.plugin(tauri_plugin_opener::init())
```

Keep existing `.plugin(tauri_plugin_dialog::init())` unchanged.

---

### 2) Add attachment preview temp paths

**File:** `src-tauri/src/data/profiles/paths.rs`
Add functions (exact signatures required):

```rust
pub fn attachments_preview_root(sp: &StoragePaths, profile_id: &str) -> PathBuf {
    profile_dir(sp, profile_id).join("tmp").join("attachments")
}

pub fn attachment_preview_path(
    sp: &StoragePaths,
    profile_id: &str,
    attachment_id: &str,
    file_name: &str
) -> PathBuf {
    attachments_preview_root(sp, profile_id)
        .join(attachment_id)
        .join(file_name)
}
```

(If filename sanitization is desired, do it in service layer before calling this, not here.)

Update `ensure_profile_dirs` to also create the tmp root:

```rust
fs::create_dir_all(root.join("tmp").join("attachments"))?;
```

---

### 3) Implement “open attachment” service

**File:** `src-tauri/src/services/attachments_service.rs`

Add imports at top:

```rust
use tauri_plugin_opener::OpenerExt;
use std::ffi::OsStr;
```

Add helper function (exact behavior):

* Replace disallowed filename characters on Windows (`<>:"/\\|?*`) with `_`.
* If resulting name is empty -> use `"attachment.bin"`.

Add new public function:

```rust
pub fn open_attachment(app: &AppHandle, attachment_id: String) -> Result<()> {
    let session = require_logged_in(app)?;

    let meta = repo_impl::get_attachment_meta(
        &session.state.repo_pool,
        &attachment_id
    )?.ok_or_else(|| ErrorCodeString::new("ATTACHMENT_NOT_FOUND"))?;

    // Read encrypted bytes from storage
    let stored_path = attachment_file_path(&session.state.storage_paths, &session.profile_id, &meta.id);
    let bytes = fs::read(&stored_path).map_err(|_| ErrorCodeString::new("ATTACHMENT_READ_FAILED"))?;

    // Decrypt if vault key exists
    let output_bytes = if let Some(key) = session.vault_key {
        cipher::decrypt_attachment_blob(&session.profile_id, &meta.id, &key, &bytes)?
    } else {
        bytes
    };

    // Build preview path under profile tmp
    // preview_root: <profile>/tmp/attachments/<attachment_id>/<sanitized_filename>
    let safe_name = sanitize_filename_for_os(&meta.file_name);
    let preview_path = crate::data::profiles::paths::attachment_preview_path(
        &session.state.storage_paths,
        &session.profile_id,
        &meta.id,
        &safe_name
    );

    ensure_target_dir(&preview_path)?;
    fs::write(&preview_path, &output_bytes).map_err(|_| ErrorCodeString::new("ATTACHMENT_WRITE_FAILED"))?;

    // Open in OS
    app.opener()
        .open_path(preview_path.clone(), Option::<String>::None)
        .map_err(|_| ErrorCodeString::new("ATTACHMENT_OPEN_FAILED"))?;

    Ok(())
}
```

Notes:

* `repo_impl::get_attachment_meta(...)` must already exist or must be implemented if missing. If you already have a function that returns `AttachmentMeta` by id (including `file_name`), use it.
* Use the same `Result`/`ErrorCodeString` style already used in this service.

---

### 4) Ensure temp decrypted previews are removed on vault lock / app exit

**File:** `src-tauri/src/services/security_service.rs`

In `lock_vault(state: &Arc<AppState>) -> Result<bool>`:
After encrypting/persisting the vault DB and before clearing session key, remove preview directory:

```rust
let active_id = { /* read active profile id similarly to existing code */ };

if let Some(id) = active_id {
    let tmp_dir = crate::data::profiles::paths::attachments_preview_root(&state.storage_paths, &id);
    let _ = std::fs::remove_dir_all(tmp_dir);
}
```

Also add the same cleanup call inside `auto_lock_cleanup(state: &Arc<AppState>)` before returning, so app close clears previews too.

---

### 5) Expose new Tauri command

**File:** `src-tauri/src/commands/attachments.rs`

Add:

```rust
#[tauri::command]
pub async fn open_attachment(app: AppHandle, attachment_id: String) -> Result<()> {
    tauri::async_runtime::spawn_blocking(move || {
        attachments_service::open_attachment(&app, attachment_id)
    })
    .await
    .map_err(|_| ErrorCodeString::new("TASK_JOIN_FAILED"))?
}
```

**File:** `src-tauri/src/main.rs`
Add `open_attachment` into `tauri::generate_handler![ ... ]` list near other attachment commands.

---

## Frontend Changes (React + TS)

### 1) Fix dialog import (Tauri v2)

Replace v1 import usage.

**File:** `src/features/Vault/components/Details/useDetails.tsx`
Change:

```ts
import { open } from '@tauri-apps/api/dialog';
```

to:

```ts
import { open } from '@tauri-apps/plugin-dialog';
```

(As per Tauri v2 dialog plugin docs.)

Also ensure the plugin is installed in npm (see “Build / Install fixes”).

---

### 2) Add frontend API wrapper for open attachment

**File:** `src/features/Vault/api/vaultApi.ts`
Add:

```ts
export async function openAttachment(attachmentId: string): Promise<void> {
  return invoke('open_attachment', { attachmentId });
}
```

---

### 3) Details panel: add “Open” action per attachment

**File:** `src/features/Vault/components/Details/useDetails.tsx`

* Import `openAttachment` from `../../api/vaultApi`.
* Add callback:

```ts
const onOpenAttachment = useCallback(async (attachmentId: string) => {
  try {
    await openAttachment(attachmentId);
  } catch (err) {
    console.error(err);
    showToast(t('toast.attachmentOpenError'), 'error');
  }
}, [showToast, t]);
```

* Add `onOpenAttachment` to returned object:

```ts
return {
  ...
  attachments,
  onAddAttachment,
  onRemoveAttachment,
  onOpenAttachment,
};
```

**File:** `src/features/Vault/components/Details/Details.tsx`

In attachments map section, extend row actions:

* Add an Open button (before Remove).
  Example structure inside `.attachment-row`:

```tsx
<button
  className="btn btn-secondary"
  type="button"
  onClick={() => detailActions.onOpenAttachment(attachment.id)}
>
  {t('attachments.open')}
</button>
```

---

### 4) Create modal: add pending attachments selection + upload after create

#### 4.1 Extend view model to store pending create attachments

**File:** `src/features/Vault/components/DataCards/useDataCards.ts`

Add type:

```ts
export type PendingAttachment = {
  path: string;
  fileName: string;
};
```

Extend `DataCardsViewModel` type to include:

```ts
createAttachments: PendingAttachment[];
addCreateAttachments: (paths: string[]) => void;
removeCreateAttachment: (path: string) => void;
clearCreateAttachments: () => void;
```

Add state:

```ts
const [createAttachments, setCreateAttachments] = useState<PendingAttachment[]>([]);
```

Add methods:

```ts
const addCreateAttachments = useCallback((paths: string[]) => {
  setCreateAttachments(prev => {
    const existing = new Set(prev.map(p => p.path));
    const next = [...prev];
    for (const p of paths) {
      if (!p || existing.has(p)) continue;
      const fileName = p.split(/[/\\]/).pop() ?? p;
      next.push({ path: p, fileName });
      existing.add(p);
    }
    return next;
  });
}, []);

const removeCreateAttachment = useCallback((path: string) => {
  setCreateAttachments(prev => prev.filter(p => p.path !== path));
}, []);

const clearCreateAttachments = useCallback(() => {
  setCreateAttachments([]);
}, []);
```

#### 4.2 Upload pending attachments after successful create

In `submitCreate` (currently calls `await onCreateCard(...)` and closes modal):

Change block:

```ts
await onCreateCard(buildCreateInput(createForm));
setCreateOpen(false);
resetCreateForm();
```

To:

```ts
const created = await onCreateCard(buildCreateInput(createForm));
if (created && createAttachments.length > 0) {
  for (const item of createAttachments) {
    try {
      await addAttachmentFromPath(created.id, item.path);
    } catch (e) {
      // continue
    }
  }

  // notify Details to refresh attachments for this card
  window.dispatchEvent(new CustomEvent('vault:attachments-changed', { detail: { datacardId: created.id } }));
}
setCreateOpen(false);
resetCreateForm();
clearCreateAttachments();
```

Notes:

* Must import `addAttachmentFromPath` from `../../api/vaultApi` at the top of `useDataCards.ts`.
* Do not block creation if attachment upload fails. Creation success is primary.

Finally, return these new properties in the hook return object.

---

### 5) Create modal UI changes

**File:** `src/features/Vault/components/DataCards/DataCards.tsx`

1. Add import:

```ts
import { open } from '@tauri-apps/plugin-dialog';
```

(Use plugin dialog for v2.)

2. In `renderDialog(...)`, insert a new section between Tags input and `.dialog-footer`:

* Button “Add file”
* Render list of `viewModel.createAttachments` (filename + remove icon/button)

Implementation requirements:

* On click Add file:

```ts
const selection = await open({ multiple: true });
const paths = Array.isArray(selection) ? selection : selection ? [selection] : [];
viewModel.addCreateAttachments(paths.filter((p): p is string => typeof p === 'string'));
```

* For each pending attachment row add remove action:

```tsx
<button type="button" className="btn btn-ghost" onClick={() => viewModel.removeCreateAttachment(a.path)}>
  ✕
</button>
```

3. Only show this section for Create dialog (dialogId === 'create-datacard'). Do not affect Edit modal unless explicitly desired.

---

## i18n strings

**File:** `src/i18n/English/DataCards.json`
Add keys:

```json
"attachments.add": "Add file",
"attachments.selected": "Selected files",
"attachments.remove": "Remove"
```

**File:** `src/i18n/English/Details.json`
Add keys:

```json
"attachments.open": "Open",
"toast.attachmentOpenError": "Unable to open attachment"
```

(If you want success toast for open, add `"toast.attachmentOpenSuccess": "Opened"` and trigger it.)

---

## Styling

**File:** `src/styles/ui.css` (or a Vault-specific css file if preferred)

Add styles to match the provided mock:

* `.dialog-attachments` container with spacing consistent with form fields
* Attachments list rows visually compact
* “Add file” button aligned left, above footer

Minimum required CSS classes to add (names are up to you, but keep consistent and scoped):

* `.dialog-attachments`
* `.dialog-attachments-header`
* `.dialog-attachments-list`
* `.dialog-attachments-item`

---

## Build / Install fixes (Windows + npm integrity issue)

User reported:

* `npm error EINTEGRITY ... wanted sha512-PLACEHOLDER but got sha512-...`

Required remediation steps (documented in README or dev notes):

1. Delete `node_modules/`
2. Delete `package-lock.json`
3. Clean npm cache:

```bat
npm cache clean --force
```

4. Install required plugins and regenerate lock:

```bat
npm install @tauri-apps/plugin-dialog@^2.0.0 @tauri-apps/plugin-opener@^2.0.0
npm install
```

The dialog plugin usage/import is per official docs.

---

## Acceptance Criteria

1. Create modal shows “Add file” button (as per mock) and allows selecting multiple files.
2. Selected files list appears; user can remove any before pressing Create.
3. Pressing Create:

   * creates card successfully
   * uploads selected files as attachments
   * Details panel for the created card shows these attachments without needing app restart (event refresh works).
4. Details attachments list includes “Open” button:

   * clicking opens attachment in OS default app.
5. When vault is locked OR app is closed:

   * decrypted preview files under `<profile>/tmp/attachments/**` are removed.


