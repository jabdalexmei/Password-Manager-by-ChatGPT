

## Technical Specification (TS) — Split “Bank cards” into a separate feature and remove BankCard from DataCards (DEV / breaking)

### 0) Goal

Implement **Bank Cards** as a **separate entity** and UI section, similar to Data Cards:

* Sidebar “Category” contains:

  * **Data cards** (shows only DataCard records)
  * **Bank cards** (shows only BankCard records)
* **Bank cards** has its own **Create/Edit dialog** (independent of Data card).
* **Data cards** must have **zero** BankCard-related fields (types, API payloads, DB columns, mapping).
* DEV mode / breaking: **old data is not needed**, destructive migration is allowed.

### 1) Requirements / Product behavior

#### 1.1 Category switching

* Add category selector in the left sidebar:

  * When category = `data_cards`: current behavior stays (folders + datacards list + datacard details).
  * When category = `bank_cards`:

    * show bank cards list/details
    * **hide folders section** and **hide “Add folder” button**
    * navigation (“All items / Favorites / Archive / Deleted”) still applies, but to bank cards.

#### 1.2 Add bank card entrypoint

* On **right-click** on “Bank cards” category item show context menu:

  * item: **Add bank card**
* Additionally (for usability), show a top sidebar action button:

  * when category = `bank_cards`: show **Add bank card** (same placement style as “Add data card”)
  * when category = `data_cards`: keep “Add data card” + “Add folder”

#### 1.3 Bank card fields (Variant 1 / simplest)

BankCard form fields (all optional except title/name):

* `Title*` (required)
* `Holder` (optional)
* `Number` (optional)
* `Expiry (MM/YY)` (optional)
* `CVC/CVV` (optional; user may store it)
* `Note` (optional)
* `Tags` (optional, comma separated)
* `Favorite` toggle supported (like datacards)

No folders for bank cards in this iteration.

### 2) Data model changes (SQLite)

#### 2.1 Update schema: remove datacards.bank_card_json

**File:** `src-tauri/src/data/sqlite/schema.sql`

Modify `datacards` table: **remove** column `bank_card_json`.

Current fragment contains:

```sql
bank_card_json TEXT,
```

Remove it completely.

Also update indexes if any rely on it (none expected).

#### 2.2 Add new table `bank_cards`

**File:** `src-tauri/src/data/sqlite/schema.sql`

Add:

```sql
CREATE TABLE IF NOT EXISTS bank_cards (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  holder TEXT,
  number TEXT,
  expiry_mm_yy TEXT,
  cvc TEXT,
  note TEXT,
  tags_json TEXT NOT NULL DEFAULT '[]',
  is_favorite INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  deleted_at TEXT
);

CREATE INDEX IF NOT EXISTS idx_bank_cards_deleted_at ON bank_cards (deleted_at);
CREATE INDEX IF NOT EXISTS idx_bank_cards_is_favorite ON bank_cards (is_favorite);
```

### 3) Migrations (DEV breaking)

#### 3.1 Bump schema version

**File:** `src-tauri/src/data/sqlite/migrations.rs`

* Increase `CURRENT_SCHEMA_VERSION` from `4` → `5`.

#### 3.2 Destructive migration strategy

Because DEV mode does not need old data, implement:
**If `user_version < 5` → drop and recreate all tables using `schema.sql`**.

**File:** `src-tauri/src/data/sqlite/migrations.rs`

Add a migration branch similar to:

* read `PRAGMA user_version`
* if `< 5`:

  * `PRAGMA foreign_keys = OFF;`
  * `DROP TABLE IF EXISTS attachments;`
  * `DROP TABLE IF EXISTS password_history;`
  * `DROP TABLE IF EXISTS datacards;`
  * `DROP TABLE IF EXISTS folders;`
  * `DROP TABLE IF EXISTS user_settings;`
  * `DROP TABLE IF EXISTS bank_cards;`
  * run full `schema.sql` via `execute_batch(include_str!("schema.sql"))`
  * `PRAGMA user_version = 5;`
  * `PRAGMA foreign_keys = ON;`

Acceptance: opening existing DB with old version results in an empty fresh vault DB but consistent schema.

### 4) Backend (Rust) changes

#### 4.1 Remove BankCard from DataCard types & inputs

**File:** `src-tauri/src/types.rs`

* Remove `BankCard` struct if it becomes unused by anything else.
* Remove `bank_card: Option<BankCard>` from:

  * `DataCardItem`
  * `CreateDataCardInput`
  * `UpdateDataCardInput`

#### 4.2 Create Bank Card types

**File:** `src-tauri/src/types.rs`

Add:

```rust
#[derive(serde::Serialize, serde::Deserialize, Debug, Clone)]
pub struct BankCardItem {
    pub id: String,
    pub title: String,
    pub holder: Option<String>,
    pub number: Option<String>,
    pub expiry_mm_yy: Option<String>,
    pub cvc: Option<String>,
    pub note: Option<String>,
    pub tags: Vec<String>,
    pub is_favorite: bool,
    pub created_at: String,
    pub updated_at: String,
    pub deleted_at: Option<String>,
}

#[derive(serde::Serialize, serde::Deserialize, Debug, Clone)]
pub struct BankCardSummary {
    pub id: String,
    pub title: String,
    pub holder: Option<String>,
    pub number: Option<String>,
    pub tags: Vec<String>,
    pub is_favorite: bool,
    pub created_at: String,
    pub updated_at: String,
    pub deleted_at: Option<String>,
}

#[derive(serde::Serialize, serde::Deserialize, Debug, Clone)]
pub struct CreateBankCardInput {
    pub title: String,
    pub holder: Option<String>,
    pub number: Option<String>,
    pub expiry_mm_yy: Option<String>,
    pub cvc: Option<String>,
    pub note: Option<String>,
    pub tags: Vec<String>,
}

#[derive(serde::Serialize, serde::Deserialize, Debug, Clone)]
pub struct UpdateBankCardInput {
    pub id: String,
    pub title: String,
    pub holder: Option<String>,
    pub number: Option<String>,
    pub expiry_mm_yy: Option<String>,
    pub cvc: Option<String>,
    pub note: Option<String>,
    pub tags: Vec<String>,
}
```

#### 4.3 Update datacards repository: remove bank_card_json read/write

**File:** `src-tauri/src/data/sqlite/repo_impl.rs`

* Remove `use crate::types::BankCard;`
* Remove:

  * `serialize_card_fields()`
  * any code reading/writing `bank_card_json`
* Update SQL:

  * `INSERT INTO datacards (...)` column list must not include `bank_card_json`
  * `UPDATE datacards SET ...` must not include `bank_card_json`
  * `SELECT ... FROM datacards` must not select `bank_card_json`

Search occurrences and delete/adjust:

* `bank_card_json`
* `bank_card`
* `serialize_card_fields`
* `map_datacard` mapping of bank_card

#### 4.4 Implement bank cards repository functions

**File:** `src-tauri/src/data/sqlite/repo_impl.rs`

Add functions mirroring datacards:

* `list_bank_cards_summary(state, profile_id) -> Result<Vec<BankCardSummary>>`
* `list_deleted_bank_cards_summary(...)`
* `get_bank_card(state, profile_id, id) -> Result<BankCardItem>`
* `create_bank_card(state, profile_id, input) -> Result<BankCardItem>`
* `update_bank_card(state, profile_id, input) -> Result<bool>`
* `set_bank_card_favorite(state, profile_id, id, is_favorite) -> Result<bool>`
* `delete_bank_card(state, profile_id, id) -> Result<bool>` (soft delete)
* `restore_bank_card(...) -> Result<bool>`
* `purge_bank_card(...) -> Result<bool>` (hard delete)

Implementation notes:

* Tags stored in `tags_json` as JSON array (same serializer as datacards uses).
* `is_favorite` stored as INTEGER (0/1).
* Use same timestamp format (`Utc::now().to_rfc3339()`).

#### 4.5 Service layer

**File:** `src-tauri/src/services/bank_cards_service.rs` (new)

Create service functions similar to `datacards_service.rs`, including:

* login checks via `security_service::require_logged_in(state, profile_id)?;`
* input validation:

  * title required (trim, non-empty) else `VALIDATION_ERROR`

#### 4.6 Commands layer

**File:** `src-tauri/src/commands/bank_cards.rs` (new)
**File:** `src-tauri/src/commands/mod.rs` (edit)
**File:** `src-tauri/src/main.rs` (edit)

Add Tauri commands:

* `list_bank_cards_summary_command`
* `list_deleted_bank_cards_summary_command`
* `get_bank_card`
* `create_bank_card`
* `update_bank_card`
* `set_bank_card_favorite`
* `delete_bank_card`
* `restore_bank_card`
* `purge_bank_card`

Register them in:

* `src-tauri/src/commands/mod.rs`: `pub mod bank_cards;`
* `src-tauri/src/main.rs`:

  * add to `mod services { ... }`: `pub mod bank_cards_service;`
  * import commands: add `bank_cards::*`
  * add to `.invoke_handler(generate_handler![ ... ])` list.

### 5) Frontend (React) changes

#### 5.1 Remove BankCard from DataCard frontend types/mappers

**File:** `src/features/Vault/types/backend.ts`

* Remove:

  * `BackendBankCard` type (or keep if used elsewhere, but target is removal)
  * `bank_card` from `BackendDataCard`
  * `bank_card` from `BackendCreateDataCardInput` / `BackendUpdateDataCardInput`

**File:** `src/features/Vault/types/ui.ts`

* Remove:

  * `BankCard` type
  * `bankCard` from `DataCard`

**File:** `src/features/Vault/types/mappers.ts`

* Remove mapping code for `bank_card` / `bankCard`.
* In `mapCreateCardToBackend()`: remove `bank_card: null`.

#### 5.2 Add bank cards API wrapper (frontend)

**File:** `src/features/Vault/api/vaultApi.ts`

Add types for backend bank cards:

* Create `BackendBankCardItem`, `BackendBankCardSummary`, `BackendCreateBankCardInput`, `BackendUpdateBankCardInput` in `src/features/Vault/types/backend.ts`.

Add API functions (invoke names must match Rust commands):

* `listBankCardSummaries()`
* `listDeletedBankCardSummaries()`
* `getBankCard(id)`
* `createBankCard(input)`
* `updateBankCard(input)`
* `setBankCardFavorite({ id, is_favorite })`
* `deleteBankCard(id)`
* `restoreBankCard(id)`
* `purgeBankCard(id)`

#### 5.3 Add bank cards UI types/mappers

**File:** `src/features/Vault/types/ui.ts`
Add:

* `BankCardItem`
* `BankCardSummary`
* `CreateBankCardInput`
* `UpdateBankCardInput`

**File:** `src/features/Vault/types/mappers.ts`
Add:

* `mapBankCardFromBackend`
* `mapBankCardSummaryFromBackend`
* `mapCreateBankCardToBackend`
* `mapUpdateBankCardToBackend`

#### 5.4 Sidebar: add Category section + context menu

**File:** `src/features/Vault/components/Folders/Folders.tsx` (or create a new sidebar component; simplest is to extend this one)

Add:

* Category title (e.g. `t('category.title')`)
* Items:

  * Data cards
  * Bank cards
* For bank cards item:

  * `onContextMenu` opens context menu overlay
  * menu item: “Add bank card” triggers open create-bank-card dialog

Also add new prop(s) to this component:

* `selectedCategory: 'data_cards' | 'bank_cards'`
* `onSelectCategory(category)`
* `onAddBankCard()` (opens modal)

Hide folders rendering when category = bank_cards:

* do not render folders list
* do not allow folder context menu / create folder

#### 5.5 Vault main layout: switch center panel by category

**File:** `src/features/Vault/Vault.tsx`

Add state:

* `selectedCategory` default = `'data_cards'`

Render:

* if `selectedCategory === 'data_cards'`: render existing `<DataCards .../>` and folders flow
* if `selectedCategory === 'bank_cards'`: render new `<BankCards .../>`

#### 5.6 Implement BankCards component (new)

**File:** `src/features/Vault/components/BankCards/BankCards.tsx` (new)

* Copy structure from `DataCards.tsx`, but fields are bank-card specific.
* Must support:

  * list summaries
  * select item -> details panel
  * create dialog
  * edit dialog
  * soft delete + restore + purge
  * favorite toggle
  * tags editing
* Password reveal patterns may be reused for `cvc` and maybe `number` (mask by default).

#### 5.7 Extend `useVault` to support both categories (or add `useBankVault`)

**Option A (least refactor, recommended):** create a second hook for bank cards.

New file:

* **`src/features/Vault/useBankCards.ts`** (new)

  * replicate minimal subset from `useVault`:

    * list active bank cards
    * list deleted bank cards
    * get details
    * create/update/delete/restore/purge/favorite

Then in `Vault.tsx`:

* keep current `useVault` for datacards+folders
* use `useBankCards` for bankcards

### 6) Acceptance Criteria

1. Data cards:

* Create/Edit dialogs and backend payloads contain **no** bank card fields.
* `datacards` table has **no** `bank_card_json` column.

2. Bank cards:

* Category switch shows bank cards only.
* Context menu on “Bank cards” shows “Add bank card”.
* Create/Edit bank card works.
* Editing an existing bank card updates correctly (no “Operation failed”).

3. Migration:

* Opening an existing vault with `user_version < 5` recreates schema and app runs.

4. UI:

* “Add folder” not visible in bank cards category.
* “Add bank card” entrypoint exists (context menu + optional button).

### 7) Manual Test Plan

* Fresh workspace → create profile → create bank card → edit → favorite → delete → restore → purge.
* Switch category back/forth; ensure lists isolate correctly.
* Verify `PRAGMA table_info(datacards)` has no bank_card_json; verify `bank_cards` table exists.
* Verify no runtime TS errors in mappers/types after removing `bank_card` from datacards.

### 8) Security note (informational)

If the app ever aims at payment compliance, PCI DSS forbids storing CVV/CVC after authorization.
For this offline manager, Variant 1 allows optional CVC storage as requested.

