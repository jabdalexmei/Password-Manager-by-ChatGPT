
# Technical Specification (EN): Custom “Choose file” button for TOTP QR upload (Variant A)

## Goal

Replace the native file input UI (“No file chosen / Choose File”) in the **Two-factor authentication (TOTP) → QR** tab with an app-styled button and a filename text area:

* **Button on the left**, filename text on the right (same visual language as the rest of the app buttons/inputs).
* Preserve the existing QR decode logic and error handling.

## Non-goals

* Do not change QR decoding algorithm/library.
* Do not change how the decoded URI is normalized/saved.
* No cross-platform requirements (Windows-only app is fine).

## Files to change

1. **UI component**
   `src/features/Vault/components/modals/Add2FAModal.tsx`

2. **CSS (shared UI)**
   `src/styles/ui.css`

3. **i18n (optional but recommended)**
   `src/i18n/English/DataCards.json`
   (If your project has other locales, mirror the same keys there as well.)

---

## 1) Add CSS helpers for “visually hidden” file input + file picker layout

**File:** `src/styles/ui.css`

### Add the following CSS block (place near other form helpers, e.g. after `.form-field--row` or anywhere in Forms section)

```css
/* ==========================================================================
   File picker (custom file input button + filename)
   --------------------------------------------------------------------------
   - Use visually-hidden technique (NOT display:none) so <label for="...">
     remains keyboard accessible and works consistently.
   ========================================================================== */
.visually-hidden {
  position: absolute !important;
  width: 1px !important;
  height: 1px !important;
  padding: 0 !important;
  margin: -1px !important;
  overflow: hidden !important;
  clip: rect(0, 0, 0, 0) !important;
  white-space: nowrap !important;
  border: 0 !important;
}

.file-picker {
  display: flex;
  align-items: center;
  gap: 12px;
}

.file-picker__btn[aria-disabled="true"] {
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: none;
}

.file-picker__name {
  flex: 1 1 auto;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
```

---

## 2) Update Add2FAModal QR tab markup (replace native file input control)

**File:** `src/features/Vault/components/modals/Add2FAModal.tsx`

### A) Add state for selected filename

Right after existing state declarations, add:

```ts
const [qrFileName, setQrFileName] = useState<string>(t('twoFactor.qr.noFileChosen'));
```

> Note: this uses i18n key introduced in section 3. If you decide to NOT add i18n keys, set `'No file chosen'` directly.

### B) Replace the QR tab `<input type="file">` block

Find the QR tab rendering section:

```tsx
<input
  id="totp-qr"
  className="input"
  type="file"
  accept="image/*"
  disabled={busy}
  onChange={(e) => {
    const file = e.target.files?.[0];
    if (file) void handleQrFile(file);
  }}
/>
```

Replace it with the following **exact** markup:

```tsx
<div className="file-picker">
  <input
    id="totp-qr"
    className="visually-hidden"
    type="file"
    accept="image/*"
    disabled={busy}
    onChange={(e) => {
      const file = e.currentTarget.files?.[0];
      if (!file) return;

      setQrFileName(file.name);

      void handleQrFile(file);

      // Allow selecting the same file again (so onChange fires again)
      e.currentTarget.value = '';
    }}
  />

  <label
    htmlFor="totp-qr"
    className="btn btn-secondary file-picker__btn"
    aria-disabled={busy ? 'true' : 'false'}
  >
    {t('twoFactor.qr.chooseFile')}
  </label>

  <div className="input file-picker__name" title={qrFileName}>
    {qrFileName}
  </div>
</div>
```

### C) Reset filename when modal opens

Inside the existing `useEffect(() => { if (!isOpen) return; ... })`, add a reset line:

```ts
setQrFileName(t('twoFactor.qr.noFileChosen'));
```

### D) Busy/error/loading behavior

Keep the existing behavior exactly as-is:

* `busy` disables file picking and shows `{t('twoFactor.qr.loading')}`
* `error` rendering remains unchanged
* `handleQrFile(...)` stays unchanged (still uses `URL.createObjectURL`, `BrowserQRCodeReader.decodeFromImageUrl`, and `normalizeTotpInput`) ([GitHub][2])

---

## 3) i18n strings for the new UI text (recommended)

**File:** `src/i18n/English/DataCards.json`

Under `"twoFactor": { "qr": { ... } }`, add:

```json
"chooseFile": "Choose file",
"noFileChosen": "No file chosen"
```

Final structure example:

```json
"qr": {
  "label": "Upload QR image",
  "chooseFile": "Choose file",
  "noFileChosen": "No file chosen",
  "loading": "Decoding QR..."
}
```

---

## Acceptance Criteria

1. In **Two-factor authentication (TOTP) → QR** tab:

   * No native browser “Choose File” button is visible anymore.
   * A normal app button (`btn btn-secondary`) is shown on the **left**, text field with filename on the **right**.
2. Clicking the new button opens file picker and accepts images only (`accept="image/*"`). ([MDN Web Docs][3])
3. When a file is selected:

   * filename updates immediately
   * decoding starts (busy state + “Decoding QR...”)
   * on success: the decoded secret/URI is normalized and tab switches to **Text** (current behavior preserved)
   * on failure: existing error messages still show
4. While `busy === true`, the “Choose file” control is effectively disabled (no picker opens; visually dimmed).

## Manual Test Plan

* Open 2FA modal → QR tab → click “Choose file” → select a QR image → verify it decodes and switches to Text.
* Select a non-QR image → verify `QR_DECODE_FAILED` appears.
* Select the **same file twice in a row** → verify decode triggers both times (because input value is reset after selection).
* During decoding (busy), attempt to click “Choose file” → verify it does nothing.

