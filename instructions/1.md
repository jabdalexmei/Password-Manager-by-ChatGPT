

# TS (EN): Fix “Create Data Card hangs” for password-protected profile (vault_session mutex re-lock deadlock)

## Goal

Fix indefinite hang when creating a Data Card in a password-protected profile by removing re-entrant locking of `state.vault_session` mutex during `create_datacard`.

## Root cause

`repo_impl::with_connection()` executes the provided closure `f` while holding `state.vault_session` mutex (non-reentrant). `repo_impl::create_datacard()` calls `get_datacard(state, profile_id, &id)` inside that closure, which re-enters `with_connection()` and tries to lock the same mutex again, causing deadlock. ([GitHub][1])

## Files

* `src-tauri/src/data/sqlite/repo_impl.rs`

## Required changes (diff-like)

### 1) Add a connection-based helper to fetch datacard by id (NO with_connection inside)

**File:** `src-tauri/src/data/sqlite/repo_impl.rs`

Add this helper function near `get_datacard` (right above it or right below it), keeping the exact same SQL and mapper:

```rs
fn get_datacard_by_id_conn(conn: &Connection, id: &str) -> Result<DataCard> {
    let mut stmt = conn
        .prepare("SELECT * FROM datacards WHERE id = ?1")
        .map_err(|_| ErrorCodeString::new("DB_QUERY_FAILED"))?;

    stmt.query_row(params![id], map_datacard)
        .map_err(|_| ErrorCodeString::new("DATACARD_NOT_FOUND"))
}
```

### 2) Rewrite public `get_datacard()` to use the helper

**Before (current):**

```rs
pub fn get_datacard(state: &Arc<AppState>, profile_id: &str, id: &str) -> Result<DataCard> {
    with_connection(state, profile_id, |conn| {
        let mut stmt = conn
            .prepare("SELECT * FROM datacards WHERE id = ?1")
            .map_err(|_| ErrorCodeString::new("DB_QUERY_FAILED"))?;

        stmt.query_row(params![id], map_datacard)
            .map_err(|_| ErrorCodeString::new("DATACARD_NOT_FOUND"))
    })
}
```

**After (required):**

```rs
pub fn get_datacard(state: &Arc<AppState>, profile_id: &str, id: &str) -> Result<DataCard> {
    with_connection(state, profile_id, |conn| get_datacard_by_id_conn(conn, id))
}
```

### 3) Fix `create_datacard()` to NOT call `get_datacard(state, ...)` inside the closure

**Locate current code:**

* `src-tauri/src/data/sqlite/repo_impl.rs`
* in `pub fn create_datacard(...)`
* the last line inside the `with_connection(..., |conn| { ... })` closure is currently:

```rs
get_datacard(state, profile_id, &id)
```

(around line ~474 in your file)

**Replace it with:**

```rs
get_datacard_by_id_conn(conn, &id)
```

So the end of `create_datacard()` becomes:

```rs
conn.execute(/* INSERT ... */)
    .map_err(|_| ErrorCodeString::new("DB_QUERY_FAILED"))?;

get_datacard_by_id_conn(conn, &id)
```

## Acceptance criteria

1. In password-protected profile, clicking “Create Data Card” completes (no infinite spinner).
2. Newly created card appears in list immediately.
3. No deadlocks when creating cards repeatedly.
4. No change required in frontend code.

## Notes

* This fix is minimal and keeps current locking strategy (`with_connection` still holds the vault_session mutex during DB operations), but removes the *nested* `with_connection` call that causes the deadlock.
* This bug class can also exist in other “create_* then get_*” patterns if they call public functions using `with_connection` inside the same closure.

