# Technical Specification (EN): Fix Rust compile errors in backup_service (rusqlite backup + walkdir iterator)

## 1) Goal

Fix build failures in `src-tauri/src/services/backup_service.rs`:

* `E0061`: incorrect arguments passed to `rusqlite::backup::Backup::new`
* `E0631` / `E0599`: iterator type mismatch caused by using `Result::ok` while `Result` is a crate alias (not `std::result::Result`) inside a `WalkDir` iterator chain.

## 2) Affected file(s)

* `src-tauri/src/services/backup_service.rs`

## 3) Change 1 — Fix rusqlite Backup::new call (E0061)

### Background

In `rusqlite 0.32.x`, `rusqlite::backup::Backup::new` takes **exactly 2 arguments**: `(from: &Connection, to: &mut Connection)` ([Docs.rs][1]).
If database names are needed, `Backup::new_with_names` exists; otherwise, `new` is sufficient for the default database ([Docs.rs][1]).

### Required code change

**File:** `src-tauri/src/services/backup_service.rs`
**Locate** the line that currently looks like:

```rust
let mut backup = rusqlite::backup::Backup::new(&src_conn, "main", &mut dest_conn, "main")
    .map_err(|_| ErrorCodeString::new("BACKUP_CREATE_FAILED"))?;
```

**Replace it with:**

```rust
let mut backup = rusqlite::backup::Backup::new(&src_conn, &mut dest_conn)
    .map_err(|_| ErrorCodeString::new("BACKUP_CREATE_FAILED"))?;
```

**Alternative (allowed only if you explicitly need DB names):**
Use `Backup::new_with_names(&src_conn, "main", &mut dest_conn, "main")` (method exists in rusqlite) ([Docs.rs][1]).

## 4) Change 2 — Fix WalkDir iterator `.filter_map(Result::ok)` conflict (E0631 / E0599)

### Background

`WalkDir::into_iter()` yields entries as `std::result::Result<walkdir::DirEntry, walkdir::Error>` and continues iteration by yielding errors as items ([Docs.rs][2]).
In your file you import `Result` from your crate (e.g. `use crate::error::{ErrorCodeString, Result};`). This shadows `std::result::Result`, so `Result::ok` points to the wrong type. This is a common source of “type mismatch in function arguments” with `filter_map(Result::ok)` patterns ([Stack Overflow][3]).

### Required code change (preferred)

**File:** `src-tauri/src/services/backup_service.rs`
Find the attachments iteration block:

```rust
for entry in WalkDir::new(&source.attachments_path)
    .into_iter()
    .filter_map(Result::ok)
    .filter(|entry| entry.file_type().is_file())
{
    ...
}
```

Replace only `.filter_map(Result::ok)` with a closure that calls `.ok()`:

```rust
for entry in WalkDir::new(&source.attachments_path)
    .into_iter()
    .filter_map(|e| e.ok())
    .filter(|entry| entry.file_type().is_file())
{
    ...
}
```

### Alternative fix (also acceptable)

Use fully qualified `std::result::Result::ok`:

```rust
.filter_map(std::result::Result::ok)
```

### Optional cleanup (recommended to prevent regressions)

If `Result` alias is not required in this file, remove it from imports:

```rust
use crate::error::{ErrorCodeString, Result};
```

Change to:

```rust
use crate::error::ErrorCodeString;
```

(Only if no other code in the file depends on `crate::error::Result`.)

## 5) Acceptance criteria

1. Project compiles without these errors:

* `error[E0061] ... Backup::new ...`
* `error[E0631] ... filter_map(Result::ok) ...`
* `error[E0599] ... method filter exists ... trait bounds were not satisfied`

2. Backup build continues to use rusqlite Online Backup API via `rusqlite::backup::Backup` as intended (no regression in backup functionality). ([Docs.rs][4])

## 6) Notes / Non-goals

* No logic changes to backup content/format are included here—only compilation fixes.
* No API changes to frontend/commands are required for this patch.

