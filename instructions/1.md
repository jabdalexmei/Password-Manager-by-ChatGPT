
## Technical Specification (EN): Show “Add/Edit 2FA” in Create Data Card action menu + wire modal to createForm

### Goal

* “Add 2FA / Edit 2FA” must appear in the action bar menu for **both** dialogs:

  * `datacard-create-dialog`
  * `datacard-edit-dialog`
* The modal must update the correct form state:

  * Create → `viewModel.updateCreateField('totpUri', ...)`
  * Edit → `viewModel.updateEditField('totpUri', ...)`

---

### 1) Update state to track which dialog opened the 2FA modal

**File:** `src/features/Vault/components/DataCards/DataCards.tsx`

#### 1.1 Add state

Near existing:

```ts
const [is2faModalOpen, setIs2faModalOpen] = useState(false);
```

Add right after it:

```ts
const [twoFactorTargetDialogId, setTwoFactorTargetDialogId] = useState<
  'datacard-create-dialog' | 'datacard-edit-dialog' | null
>(null);
```

---

### 2) Show “Add/Edit 2FA” menu item for BOTH dialogs

**File:** `src/features/Vault/components/DataCards/DataCards.tsx`

Inside `renderDialog(...)`, find this block (currently only for edit):

```tsx
{dialogId === 'datacard-edit-dialog' && (
  <button
    type="button"
    className="dialog-actionmenu-item"
    onClick={() => {
      setIsActionMenuOpen(false);
      setIs2faModalOpen(true);
    }}
  >
    {viewModel.editForm?.totpUri ? t('twoFactor.editAction') : t('twoFactor.addAction')}
  </button>
)}
```

**Replace the entire block** with this (no `dialogId === ...` condition):

```tsx
<button
  type="button"
  className="dialog-actionmenu-item"
  onClick={() => {
    setIsActionMenuOpen(false);
    setTwoFactorTargetDialogId(dialogId === 'datacard-create-dialog' ? 'datacard-create-dialog' : 'datacard-edit-dialog');
    setIs2faModalOpen(true);
  }}
>
  {form.totpUri?.trim() ? t('twoFactor.editAction') : t('twoFactor.addAction')}
</button>
```

Notes:

* We use `form.totpUri` (it’s already passed into `renderDialog`), so it works for both create/edit.

---

### 3) Reset `twoFactorTargetDialogId` when dialogs close

**File:** `src/features/Vault/components/DataCards/DataCards.tsx`

In the existing effect:

```ts
useEffect(() => {
  if (isCreateOpen || isEditOpen) return;
  ...
  setIs2faModalOpen(false);
}, [isCreateOpen, isEditOpen]);
```

Add after `setIs2faModalOpen(false);`:

```ts
setTwoFactorTargetDialogId(null);
```

---

### 4) Make ESC close the 2FA modal first

**File:** `src/features/Vault/components/DataCards/DataCards.tsx`

In the `handleKeyDown` effect, you already handle Escape for action menu / custom field modal / rename modal.

Add this check **right after** the `if (isActionMenuOpen) ...` block (or before closing edit/create dialogs):

```ts
if (is2faModalOpen) {
  setIs2faModalOpen(false);
  setTwoFactorTargetDialogId(null);
  return;
}
```

---

### 5) Render `<Add2FAModal />` with correct form (create vs edit)

**File:** `src/features/Vault/components/DataCards/DataCards.tsx`

Find current render:

```tsx
<Add2FAModal
  isOpen={is2faModalOpen}
  existingUri={viewModel.editForm?.totpUri ?? null}
  defaults={{
    issuer: (viewModel.editForm?.title ?? 'Vault').trim() || 'Vault',
    label: (viewModel.editForm?.title ?? 'Account').trim() || 'Account',
  }}
  onCancel={() => setIs2faModalOpen(false)}
  onSave={(uri) => {
    viewModel.updateEditField('totpUri', uri);
    setIs2faModalOpen(false);
  }}
  onRemove={() => {
    viewModel.updateEditField('totpUri', '');
    setIs2faModalOpen(false);
  }}
/>
```

**Replace it fully** with:

```tsx
<Add2FAModal
  isOpen={is2faModalOpen}
  existingUri={
    twoFactorTargetDialogId === 'datacard-create-dialog'
      ? (viewModel.createForm.totpUri.trim() ? viewModel.createForm.totpUri : null)
      : (viewModel.editForm?.totpUri?.trim() ? viewModel.editForm.totpUri : null)
  }
  defaults={{
    issuer:
      twoFactorTargetDialogId === 'datacard-create-dialog'
        ? ((viewModel.createForm.title ?? 'Vault').trim() || 'Vault')
        : ((viewModel.editForm?.title ?? 'Vault').trim() || 'Vault'),
    label:
      twoFactorTargetDialogId === 'datacard-create-dialog'
        ? ((viewModel.createForm.title ?? 'Account').trim() || 'Account')
        : ((viewModel.editForm?.title ?? 'Account').trim() || 'Account'),
  }}
  onCancel={() => {
    setIs2faModalOpen(false);
    setTwoFactorTargetDialogId(null);
  }}
  onSave={(uri) => {
    if (twoFactorTargetDialogId === 'datacard-create-dialog') {
      viewModel.updateCreateField('totpUri', uri);
    } else {
      viewModel.updateEditField('totpUri', uri);
    }
    setIs2faModalOpen(false);
    setTwoFactorTargetDialogId(null);
  }}
  onRemove={() => {
    if (twoFactorTargetDialogId === 'datacard-create-dialog') {
      viewModel.updateCreateField('totpUri', '');
    } else {
      viewModel.updateEditField('totpUri', '');
    }
    setIs2faModalOpen(false);
    setTwoFactorTargetDialogId(null);
  }}
/>
```

---

### 6) Acceptance Criteria

1. In **Create data card** dialog, action bar menu shows **Add 2FA**.
2. After adding 2FA in Create dialog and saving the card, the created card has `totpUri` persisted and appears in Details.
3. In **Edit data card** dialog, action bar menu shows **Add 2FA** or **Edit 2FA** depending on presence of `totpUri`.
4. ESC closes 2FA modal without closing the parent Create/Edit dialog.


