
# Technical Specification (EN): Show “Edit fields” in Create Data Card and allow editing custom fields

## Problem

In **Create data card** dialog, the action menu contains only:

* Add/Edit 2FA
* Add field

After adding a custom field, **“Edit fields”** still does not appear. This is incorrect because user must be able to edit (rename/delete) custom fields while creating a data card.

## Root Cause

In `DataCards.tsx`, the action menu item “Edit fields” is rendered only when `dialogId === 'datacard-edit-dialog'`. Therefore, it never appears in `datacard-create-dialog`.

Additionally, rename/delete actions for custom fields are implemented only for the edit dialog and use edit-form-only view model methods.

## Goal

1. In **Create data card** dialog, after at least one custom field is added, action menu must show **Edit fields**.
2. When “Edit fields” mode is enabled in Create dialog, custom fields can be **renamed** and **deleted**, same as in Edit dialog.
3. Existing logic for Add 2FA / Add field must remain unchanged.

## Scope

Frontend only.

## Files to change

* `src/features/Vault/components/DataCards/DataCards.tsx`
* `src/features/Vault/components/DataCards/useDataCards.ts`

---

## 1) Backend/view model: add Create-mode rename/delete methods

### File

`src/features/Vault/components/DataCards/useDataCards.ts`

### 1.1 Update `DataCardsViewModel` type

In the `DataCardsViewModel` interface, add:

```ts
renameCreateCustomFieldById: (
  rowId: string,
  nextName: string
) => { ok: true } | { ok: false; reason: 'EMPTY' | 'DUPLICATE' };

removeCreateCustomFieldById: (rowId: string) => void;
```

### 1.2 Implement `renameCreateCustomFieldById`

Add a `useCallback` implementation analogous to `renameEditCustomFieldById`, but operating on `createForm.customFields`.

Exact logic:

* `trim(nextName)`
* if empty -> `{ ok:false, reason:'EMPTY' }`
* if another row (different id) already has same key (case-insensitive) -> `{ ok:false, reason:'DUPLICATE' }`
* else update row.key to trimmed value in `createForm.customFields`
* return `{ ok:true }`

### 1.3 Implement `removeCreateCustomFieldById`

Add `useCallback` that removes the row from `createForm.customFields` by `rowId`.

### 1.4 Export methods in returned view model object

Ensure both new methods are included in the object returned by `useDataCards()`.

---

## 2) UI: show “Edit fields” in Create dialog and enable rename/delete actions

### File

`src/features/Vault/components/DataCards/DataCards.tsx`

### 2.1 Add state to track which dialog is being renamed

Add state near existing rename states:

```ts
const [renameTargetDialogId, setRenameTargetDialogId] = useState<
  'datacard-create-dialog' | 'datacard-edit-dialog' | null
>(null);
```

### 2.2 Show “Edit fields” action menu item for Create dialog when custom fields exist

Locate the action menu section inside `renderDialog()`.

**Current code (only edit dialog):**

```tsx
{dialogId === 'datacard-edit-dialog' && (
  <button
    type="button"
    className="dialog-actionmenu-item"
    onClick={() => {
      setIsActionMenuOpen(false);
      setIsEditFieldsMode((prev) => !prev);
    }}
  >
    {t('customFields.editFields')}
  </button>
)}
```

**Replace with (both dialogs, only if there is at least 1 custom field):**

```tsx
{(form?.customFields?.length ?? 0) > 0 && (
  <button
    type="button"
    className="dialog-actionmenu-item"
    onClick={() => {
      setIsActionMenuOpen(false);
      setIsEditFieldsMode((prev) => !prev);
    }}
  >
    {t('customFields.editFields')}
  </button>
)}
```

### 2.3 Enable rename/delete icons in Create dialog when Edit fields mode is ON

Locate the custom fields rendering block where rename/delete buttons are currently gated like:

```tsx
{dialogId === 'datacard-edit-dialog' && isEditFieldsMode && (
  <div className="input-actions">
    ...
  </div>
)}
```

**Change condition to:**

```tsx
{isEditFieldsMode && (
  <div className="input-actions">
    ...
  </div>
)}
```

### 2.4 Make rename button work for both create/edit dialogs

Inside the rename button `onClick`, set `renameTargetDialogId`:

```tsx
onClick={() => {
  setRenameTargetRowId(row.id);
  setRenameTargetDialogId(dialogId === 'datacard-create-dialog' ? 'datacard-create-dialog' : 'datacard-edit-dialog');
  setRenameName(row.key);
  setRenameError(null);
  setIsRenameModalOpen(true);
}}
```

### 2.5 Make delete button work for both create/edit dialogs

Replace the current delete handler:

```tsx
onClick={() => viewModel.removeEditCustomFieldById(row.id)}
```

with:

```tsx
onClick={() => {
  if (dialogId === 'datacard-create-dialog') {
    viewModel.removeCreateCustomFieldById(row.id);
  } else {
    viewModel.removeEditCustomFieldById(row.id);
  }
}}
```

### 2.6 Update `CustomFieldRenameModal` confirm logic to route to correct method

Locate the rename modal confirm code which currently calls only:

```ts
const result = viewModel.renameEditCustomFieldById(renameTargetRowId, renameName);
```

Replace with:

```ts
if (!renameTargetRowId || !renameTargetDialogId) {
  setIsRenameModalOpen(false);
  setRenameError(null);
  return;
}

const result =
  renameTargetDialogId === 'datacard-create-dialog'
    ? viewModel.renameCreateCustomFieldById(renameTargetRowId, renameName)
    : viewModel.renameEditCustomFieldById(renameTargetRowId, renameName);

if (!result.ok) {
  setRenameError(
    result.reason === 'EMPTY' ? t('customFields.errorEmpty') : t('customFields.errorDuplicate')
  );
  return;
}

setIsRenameModalOpen(false);
setRenameError(null);
setRenameTargetRowId(null);
setRenameTargetDialogId(null);
```

### 2.7 Reset edit-fields mode when closing Create dialog

Currently `handleCloseEditModal()` resets `setIsEditFieldsMode(false)`, but Create uses `viewModel.closeCreateModal` directly.

Add a wrapper:

```ts
const handleCloseCreateModal = useCallback(() => {
  viewModel.closeCreateModal();
  setIsEditFieldsMode(false);
  setIsRenameModalOpen(false);
  setRenameError(null);
  setRenameTargetRowId(null);
  setRenameTargetDialogId(null);
}, [viewModel]);
```

Then, in the `renderDialog(...)` call for create dialog, replace `viewModel.closeCreateModal` with `handleCloseCreateModal`.

---

## Acceptance Criteria

1. Open **Create data card** → action menu shows only Add 2FA + Add field initially.
2. Add a custom field → action menu now includes **Edit fields**.
3. Toggle **Edit fields** ON in Create dialog:

   * rename icon appears for each custom field and works
   * delete icon appears for each custom field and works
4. Create dialog save/create flow is unchanged.
5. Closing Create dialog resets edit-fields mode and closes rename modal if open.

