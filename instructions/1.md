

# Technical Specification (EN): Clipboard Auto-Clear (default 20s) + Settings toggle + apply to copy actions

## Goal

Implement **clipboard auto-clear** feature controlled by user settings:

**Defaults (hardcoded):**

* `clipboard_auto_clear_enabled = true`
* `clipboard_clear_timeout_seconds = 20`

**Settings UI (Security section):**

* `Enable clipboard auto-clear` — toggle switch (green when ON)
* `Clipboard clear timeout (seconds)` — numeric input (seconds)

**Behavior:**

* When the user copies a **secret** value (password, CVC, generated password, etc.), and auto-clear is enabled:

  * start a timer for `clipboard_clear_timeout_seconds`
  * when timer fires: **only clear clipboard if clipboard still equals the last copied value**
  * otherwise do nothing (avoid wiping user’s new clipboard content)

This “clear only if unchanged” rule is already used in your `useDetails` copy logic; we will keep the same safe behavior.

---

## Scope

* Backend settings model defaults + JSON backward compatibility
* Settings UI (toggle + timeout)
* Copy flows:

  * Details (data cards secrets)
  * Bank card details secrets
  * Password history dialog copy
  * Generated password copy (Create data card)

Windows-only is fine (we keep WebView clipboard API, no OS-level idle APIs).

---

## Files to change

### Backend (Rust)

1. `src-tauri/src/types.rs`
2. `src-tauri/src/services/settings_service.rs`

### Frontend (React/TS)

3. `src/features/Vault/types/backend.ts`
4. `src/features/Vault/components/modals/SettingsModal.tsx`
5. `src/features/Vault/Vault.tsx`
6. `src/features/Vault/components/Details/Details.tsx`
7. `src/features/Vault/components/Details/useDetails.tsx`
8. `src/features/Vault/components/BankCards/BankCardDetails.tsx`
9. `src/features/Vault/components/BankCards/useBankCardDetails.tsx`
10. `src/features/Vault/components/modals/PasswordHistoryDialog.tsx`
11. `src/features/Vault/components/DataCards/DataCards.tsx`

---

# 1) Backend: add toggle field + defaults + serde fallbacks

## 1.1 `UserSettings` struct: add `clipboard_auto_clear_enabled` and default attributes

**File:** `src-tauri/src/types.rs`

### Change A — extend struct

Find current field:

```rust
pub clipboard_clear_timeout_seconds: i64,
```

Replace with:

```rust
#[serde(default = "default_clipboard_auto_clear_enabled")]
pub clipboard_auto_clear_enabled: bool,

#[serde(default = "default_clipboard_clear_timeout_seconds")]
pub clipboard_clear_timeout_seconds: i64,
```

> Why: without `#[serde(default=...)]`, older `user_settings.json` missing new fields can fail to deserialize.

### Change B — add default functions

In the same file (near other `default_*` helpers), add:

```rust
fn default_clipboard_auto_clear_enabled() -> bool {
    true
}

fn default_clipboard_clear_timeout_seconds() -> i64 {
    20
}
```

### Change C — update `impl Default for UserSettings`

Find:

```rust
clipboard_clear_timeout_seconds: 30,
```

Replace with:

```rust
clipboard_auto_clear_enabled: default_clipboard_auto_clear_enabled(),
clipboard_clear_timeout_seconds: default_clipboard_clear_timeout_seconds(),
```

✅ Result: new profiles default to **enabled + 20s**; old profiles get defaults automatically.

---

## 1.2 Validation

**File:** `src-tauri/src/services/settings_service.rs`

You already validate:

```rust
in_range(settings.clipboard_clear_timeout_seconds, 1, 600),
```

Leave it as-is (range 1..600).
No extra validation needed for the boolean toggle.

---

# 2) Frontend: update settings type

**File:** `src/features/Vault/types/backend.ts`

In `BackendUserSettings`, add:

```ts
clipboard_auto_clear_enabled: boolean;
```

Ensure the order doesn’t matter but keep it near clipboard fields, e.g.

```ts
clipboard_auto_clear_enabled: boolean;
clipboard_clear_timeout_seconds: number;
```

---

# 3) Settings UI: add toggle + seconds input in “Security” section

**File:** `src/features/Vault/components/modals/SettingsModal.tsx`

## 3.1 State

Add state:

```tsx
const [clipboardAutoClearEnabled, setClipboardAutoClearEnabled] = useState(false);
const [clipboardClearTimeoutSeconds, setClipboardClearTimeoutSeconds] = useState('20');
```

## 3.2 Hydration on open

Inside the existing `useEffect` that loads `settings` into state, add:

```tsx
setClipboardAutoClearEnabled(settings.clipboard_auto_clear_enabled);
setClipboardClearTimeoutSeconds(String(settings.clipboard_clear_timeout_seconds));
```

## 3.3 Validation (`canSave`)

Add:

```tsx
const clipTimeout = Number(clipboardClearTimeoutSeconds);
if (!Number.isFinite(clipTimeout) || clipTimeout < 1 || clipTimeout > 600) return false;
```

> Important: backend validates timeout regardless of enabled state, so keep it valid even when toggle OFF.

## 3.4 Save payload

In `handleSave`, parse + validate:

```tsx
const clipTimeout = Number(clipboardClearTimeoutSeconds);
if (!Number.isFinite(clipTimeout) || clipTimeout < 1 || clipTimeout > 600) return;
```

And include in `nextSettings`:

```tsx
clipboard_auto_clear_enabled: clipboardAutoClearEnabled,
clipboard_clear_timeout_seconds: clipTimeout,
```

## 3.5 UI controls

In the “Security” section (same style as auto-lock and backup toggles):

### Toggle row (IMPORTANT: do NOT use `<label htmlFor>` to avoid toggling when clicking text)

```tsx
<div className="form-field" style={toggleRowStyle}>
  <span className="form-label" id="clipboard-auto-clear-enabled-label">
    Enable clipboard auto-clear
  </span>

  <div style={{ display: 'flex', justifyContent: 'center' }}>
    <button
      id="clipboard-auto-clear-enabled-switch"
      type="button"
      role="switch"
      aria-checked={clipboardAutoClearEnabled}
      aria-labelledby="clipboard-auto-clear-enabled-label"
      disabled={busy}
      onClick={() => setClipboardAutoClearEnabled((v) => !v)}
      onKeyDown={(e) => {
        if (busy) return;
        if (e.key === ' ' || e.key === 'Enter') {
          e.preventDefault();
          setClipboardAutoClearEnabled((v) => !v);
        }
      }}
      style={/* same green switch style you use for others */ }
    >
      <span style={/* thumb style */} />
    </button>
  </div>
</div>
```

### Timeout input

```tsx
<div className="form-field">
  <label className="form-label" htmlFor="clipboard-clear-timeout-seconds">
    Clipboard clear timeout (seconds)
  </label>
  <input
    id="clipboard-clear-timeout-seconds"
    type="number"
    min={1}
    max={600}
    value={clipboardClearTimeoutSeconds}
    disabled={busy || !clipboardAutoClearEnabled}
    inputMode="numeric"
    onChange={(e) => setClipboardClearTimeoutSeconds(e.target.value)}
    style={fullWidthInputStyle}
  />
</div>
```

---

# 4) Pass settings into copy-capable components

## 4.1 Vault → Details and BankCardDetails

**File:** `src/features/Vault/Vault.tsx`

### Details props add:

```tsx
clipboardAutoClearEnabled={vault.settings?.clipboard_auto_clear_enabled}
clipboardClearTimeoutSeconds={vault.settings?.clipboard_clear_timeout_seconds}
```

### BankCardDetails props add:

```tsx
clipboardAutoClearEnabled={vault.settings?.clipboard_auto_clear_enabled}
clipboardClearTimeoutSeconds={vault.settings?.clipboard_clear_timeout_seconds}
```

### DataCards props add (new props):

```tsx
<DataCards
  viewModel={dataCardsViewModel}
  sectionTitle={vault.currentSectionTitle}
  clipboardAutoClearEnabled={vault.settings?.clipboard_auto_clear_enabled}
  clipboardClearTimeoutSeconds={vault.settings?.clipboard_clear_timeout_seconds}
/>
```

---

# 5) Implement auto-clear logic in all copy flows

## Shared rule

When copying secret text:

1. `writeText(value)`
2. if enabled:

   * store `lastCopiedValueRef = value`
   * start timer for `timeoutMs`
   * when timer fires:

     * `readText()`
     * if clipboard equals `lastCopiedValueRef`, then `writeText('')`

This prevents wiping user clipboard if user copied something else in the meantime.

---

## 5.1 Details hook (already has safe logic) — add toggle support + default 20

**File:** `src/features/Vault/components/Details/useDetails.tsx`

### Change A — default constant

Replace:

```ts
const DEFAULT_CLIPBOARD_CLEAR_TIMEOUT_SECONDS = 30;
```

with:

```ts
const DEFAULT_CLIPBOARD_CLEAR_TIMEOUT_SECONDS = 20;
```

### Change B — params type

Extend params:

```ts
clipboardAutoClearEnabled?: boolean;
clipboardClearTimeoutSeconds?: number;
```

### Change C — scheduling condition

Replace:

```ts
if (opts.isSecret) {
  ...
}
```

with:

```ts
const autoClearEnabled = clipboardAutoClearEnabled ?? true;

if (opts.isSecret && autoClearEnabled) {
  ...
}
```

### Change D — dependency array

Add `clipboardAutoClearEnabled` to `useCallback` deps.

---

## 5.2 Bank card details hook — same as above

**File:** `src/features/Vault/components/BankCards/useBankCardDetails.tsx`

* change default constant 30 → 20
* add `clipboardAutoClearEnabled?: boolean` param
* wrap timer in `if (opts.isSecret && (clipboardAutoClearEnabled ?? true))`

---

## 5.3 PasswordHistoryDialog — add auto-clear for copied historical password

**File:** `src/features/Vault/components/modals/PasswordHistoryDialog.tsx`

### Props

Extend props:

```ts
clipboardAutoClearEnabled?: boolean;
clipboardClearTimeoutSeconds?: number;
```

### Add refs + helper (same pattern as useDetails)

Add near top of component:

```tsx
const timeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
const lastCopiedValueRef = useRef<string | null>(null);

const clearPendingTimeout = useCallback(() => {
  if (timeoutRef.current) {
    clearTimeout(timeoutRef.current);
    timeoutRef.current = null;
  }
  lastCopiedValueRef.current = null;
}, []);
```

Add cleanup:

```tsx
useEffect(() => clearPendingTimeout, [clearPendingTimeout]);
```

### Update copy handler

Replace `copyPassword` with:

```tsx
const DEFAULT_CLIPBOARD_CLEAR_TIMEOUT_SECONDS = 20;

const copyPassword = useCallback(
  async (value: string) => {
    if (!value || !value.trim()) return;
    clearPendingTimeout();

    try {
      await navigator.clipboard.writeText(value);
      showToast(t('toast.copySuccess'), 'success');

      const enabled = clipboardAutoClearEnabled ?? true;
      if (!enabled) return;

      lastCopiedValueRef.current = value;
      const timeoutMs =
        (clipboardClearTimeoutSeconds ?? DEFAULT_CLIPBOARD_CLEAR_TIMEOUT_SECONDS) * 1000;

      timeoutRef.current = window.setTimeout(async () => {
        try {
          const current = await navigator.clipboard.readText();
          if (current === lastCopiedValueRef.current) {
            await navigator.clipboard.writeText('');
          }
        } catch (err) {
          console.error(err);
        } finally {
          timeoutRef.current = null;
          lastCopiedValueRef.current = null;
        }
      }, timeoutMs);
    } catch (err) {
      console.error(err);
      showToast(t('toast.copyError'), 'error');
      clearPendingTimeout();
    }
  },
  [clearPendingTimeout, clipboardAutoClearEnabled, clipboardClearTimeoutSeconds, showToast, t]
);
```

---

## 5.4 DataCards: generated password copy must respect settings

**File:** `src/features/Vault/components/DataCards/DataCards.tsx`

### Add props to component

Extend props type:

```ts
clipboardAutoClearEnabled?: boolean;
clipboardClearTimeoutSeconds?: number;
```

### Add refs near top-level of component

```tsx
const genPwdTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
const genPwdLastCopiedRef = useRef<string | null>(null);

const clearGenPwdTimer = useCallback(() => {
  if (genPwdTimeoutRef.current) {
    clearTimeout(genPwdTimeoutRef.current);
    genPwdTimeoutRef.current = null;
  }
  genPwdLastCopiedRef.current = null;
}, []);
useEffect(() => clearGenPwdTimer, [clearGenPwdTimer]);
```

### Update `handleCopyGeneratedPassword`

Replace current implementation with:

```tsx
const DEFAULT_CLIPBOARD_CLEAR_TIMEOUT_SECONDS = 20;

const handleCopyGeneratedPassword = async () => {
  if (!generatedPassword || !generatedPassword.trim()) return;

  clearGenPwdTimer();

  try {
    await navigator.clipboard.writeText(generatedPassword);
    showToast(t('toast.copySuccess'), 'success');

    const enabled = clipboardAutoClearEnabled ?? true;
    if (!enabled) return;

    genPwdLastCopiedRef.current = generatedPassword;
    const timeoutMs =
      (clipboardClearTimeoutSeconds ?? DEFAULT_CLIPBOARD_CLEAR_TIMEOUT_SECONDS) * 1000;

    genPwdTimeoutRef.current = window.setTimeout(async () => {
      try {
        const current = await navigator.clipboard.readText();
        if (current === genPwdLastCopiedRef.current) {
          await navigator.clipboard.writeText('');
        }
      } catch (err) {
        console.error(err);
      } finally {
        genPwdTimeoutRef.current = null;
        genPwdLastCopiedRef.current = null;
      }
    }, timeoutMs);
  } catch (error) {
    console.error(error);
    showToast(t('toast.copyError'), 'error');
    clearGenPwdTimer();
  }
};
```

---

# Acceptance Criteria

1. Defaults:

* New / missing settings ⇒ `clipboard_auto_clear_enabled=true`, `clipboard_clear_timeout_seconds=20`.

2. Settings modal:

* Security section contains “Enable clipboard auto-clear” (toggle) + “Clipboard clear timeout (seconds)” input.
* Toggle ON is green.
* Input disabled when toggle OFF.

3. Behavior:

* Copy secret values in:

  * Details
  * BankCardDetails
  * PasswordHistoryDialog
  * Generated password copy
    clears clipboard after N seconds **only if clipboard still matches last copied secret**.

4. No regressions: copy still shows success/error toasts.


