

# Technical Specification: Fix `OwnedData` construction for rusqlite deserialize (Tauri v2 project)

## Goal

Fix compilation error:
`error[E0277]: the trait bound OwnedData: From<Vec<u8>> is not satisfied`

by constructing `rusqlite::serialize::OwnedData` using SQLite-allocated memory, as required by rusqliteâ€™s serialization API. ([Docs.rs][1])

## Scope

Backend only (`src-tauri`), `security_service.rs` only.

---

## Change 1: Replace `Vec<u8>.into()` with SQLite allocation + `OwnedData::from_raw_nonnull`

### File

`src-tauri/src/services/security_service.rs`

### Required imports

Ensure these imports exist (add if missing):

```rust
use rusqlite::DatabaseName;
use rusqlite::serialize::OwnedData;
use rusqlite::ffi;

use std::ptr::NonNull;
```

### Add helper function (exact code)

Add this helper function near the top of the file (below imports), or in a small `mod` inside this file:

```rust
fn owned_data_from_bytes(bytes: Vec<u8>) -> anyhow::Result<OwnedData> {
    if bytes.is_empty() {
        return Err(anyhow::anyhow!("EMPTY_SERIALIZED_DB"));
    }

    // Allocate using SQLite allocator (required by OwnedData::from_raw_nonnull).
    let sz = bytes.len();
    let ptr = unsafe { ffi::sqlite3_malloc64(sz as u64) as *mut u8 };

    let nn = NonNull::new(ptr).ok_or_else(|| anyhow::anyhow!("SQLITE_OOM"))?;

    unsafe {
        std::ptr::copy_nonoverlapping(bytes.as_ptr(), nn.as_ptr(), sz);
        // Safety: ptr was allocated by sqlite3_malloc64, as required by rusqlite.
        Ok(OwnedData::from_raw_nonnull(nn, sz))
    }
}
```

### Replace the failing line

Find the code that currently does:

```rust
let owned: OwnedData = decrypted.into();
conn.deserialize(DatabaseName::Main, owned, false)?;
```

Replace with:

```rust
let owned = owned_data_from_bytes(decrypted)?;
conn.deserialize(DatabaseName::Main, owned, false)?;
```

