
---

# VAULT-SORTING-CANON-01 — Canonical sorting for folders and data cards (no order drift)

## Goal

Ensure Vault UI ordering is always canonical and stable:

* Folders are always sorted **name ASC**
* Data cards list and Deleted data cards list are always sorted according to **current settings**:

  * `default_sort_field` + `default_sort_direction`
  * with the same secondary tie-break rules as backend

No more “items appended to the end” after create/update/move/restore/delete.

## Scope

Frontend only:

* `src/features/Vault/useVault.ts`
* `src/features/Vault/types/*` (if needed for shared comparators)

## Sorting rules (must match backend)

### Folders

* `name ASC` (case-insensitive)
* tie-breaker: `id ASC`

### Data cards (active + deleted lists)

Primary/secondary rules must match backend `repo_impl.rs`:

* If `default_sort_field == "updated_at"`:

  * `DESC`: updated_at DESC, title ASC
  * `ASC`:  updated_at ASC, title ASC

* If `default_sort_field == "created_at"`:

  * `DESC`: created_at DESC, title ASC
  * `ASC`:  created_at ASC, title ASC

* If `default_sort_field == "title"`:

  * `ASC`:  title ASC, updated_at DESC
  * `DESC`: title DESC, updated_at DESC

If unknown settings are present, fall back to: `updated_at DESC, title ASC`.

## Required implementation

### 1) Add comparator helpers

**File:** `src/features/Vault/types/sort.ts` (create)

Export:

```ts
export function sortFolders(a: Folder, b: Folder): number;
export function sortCards(a: DataCardSummary, b: DataCardSummary, sortField: string, sortDir: string): number;
```

Implementation requirements:

* Case-insensitive compare for titles/names
* Dates are ISO strings: compare by `Date.parse()`
* Tie-break strictly per rules above

### 2) Apply sorting on every state write

**File:** `src/features/Vault/useVault.ts`

Every time you update these states, you must re-sort:

* `setFolders(...)` → always `.sort(sortFolders)`
* `setCards(...)` → always `.sort((a,b)=>sortCards(a,b, settings.defaultSortField, settings.defaultSortDirection))`
* `setDeletedCards(...)` → same as `setCards` (or a dedicated comparator if deleted list has different server order)

Concrete required changes (examples):

* After create folder: append then sort
* After rename folder: update then sort
* After create card: insert then sort
* After update card: update then sort
* After move card: update then sort
* After delete/restore: remove/add then sort

### 3) Ensure refresh paths also sort

When lists are fetched from backend (`refreshActive`, `refreshTrash`), still run sorting in frontend to guarantee consistent order even if backend changes later.

## Acceptance criteria

1. After any action (create/update/delete/restore/move), lists remain in correct canonical order.
2. No “new item always appears at bottom” behavior.
3. Sort respects current user settings exactly.

---

# VAULT-SECURITY-UX-01 — Clipboard safety + cryptographically secure password generator

## Goal

Fix two UX/security issues:

1. Clipboard auto-clear must **not** erase user clipboard content if user copied something else after copying from the app.
2. Password generator must use **crypto-secure randomness** (`crypto.getRandomValues`), not `Math.random()`.

## Scope

Frontend only:

* `src/features/Vault/components/Details/useDetails.tsx`
* `src/features/Vault/components/DataCards/useDataCards.ts` (or wherever generator is implemented)

---

## 1) Clipboard auto-clear: “clear only if we still own the clipboard”

### File

`src/features/Vault/components/Details/useDetails.tsx`

### Current bad behavior

After copying a password, a timer later runs `navigator.clipboard.writeText('')` unconditionally.

### Required behavior

* When copying, store the exact string we wrote to clipboard (`copiedValue`) and timestamp.
* On timeout (e.g., 20–30 seconds), read clipboard:

  * if clipboard content equals `copiedValue`, then clear it (write empty string)
  * if clipboard content is different, do nothing (user copied something else)

### Implementation requirements

* Use a `useRef` to store `lastCopiedValue` and timer id.
* Always clear previous timer before setting a new one.
* Wrap clipboard read/write in try/catch:

  * If read is blocked by permissions, skip the “compare” and **do not clear** (safety first).

### Acceptance criteria

1. App clears clipboard only if clipboard still contains what the app copied.
2. If user copies anything else after copying password, app does not overwrite it.

---

## 2) Password generator: crypto RNG

### File

`src/features/Vault/components/DataCards/useDataCards.ts` (or the current generator location)

### Requirements

* Replace any `Math.random()` usage with:

  * `crypto.getRandomValues(new Uint32Array(n))`
* Provide a helper:

```ts
function randomInt(maxExclusive: number): number;
```

that uses secure random source and modulo bias-safe selection (required).

### Charset and rules (keep current UI options if present)

If you currently generate from a fixed charset, keep it (do not change UX), only change randomness.

**Bias-safe requirement:**
Use rejection sampling:

* generate a random uint32
* take `x % max`
* accept only if `x < floor(2^32 / max) * max`

### Acceptance criteria

1. No `Math.random()` remains in password generation code path.
2. Generated passwords are stable-length and use secure randomness.

---

## Done means

* Sorting is stable and canonical after all UI actions.
* Clipboard clear no longer breaks user clipboard.
* Password generation is crypto-secure.

---
