

# SPEC — FOLDERS-HARD-DELETE-01

## Permanent folder deletion + modal choice when folder contains cards

## 0) Goal

1. Remove “deleted folders” functionality from the app.
2. Make folder deletion **permanent**.
3. If folder contains any data cards, show a modal with two actions:

* **Delete folder only** (move cards to root/All)
* **Delete folder and cards** (delete cards too)

## 1) Backend changes (Rust/Tauri)

### 1.1 Remove soft-delete folders behavior

#### File: `src-tauri/src/services/folders_service.rs`

**Change `delete_folder` behavior**:

* Must **not** call `soft_delete_folder`
* Must **not** call `soft_delete_datacards_in_folder` automatically
* Must become “prepare/route” to new permanent delete flow (see below)

**Keep restriction**: system folders cannot be deleted (existing `folder.is_system` check stays).

---

### 1.2 Add two new service functions

#### File: `src-tauri/src/services/folders_service.rs`

Add:

```rust
pub fn delete_folder_only(id: String, state: &Arc<AppState>) -> Result<bool>;
pub fn delete_folder_and_cards(id: String, state: &Arc<AppState>) -> Result<bool>;
```

Rules:

**delete_folder_only**

1. Require logged in (existing `require_logged_in`)
2. Load folder (`repo_impl::get_folder`)
3. If `is_system` → `FOLDER_IS_SYSTEM`
4. Move all datacards from this folder to root:

   * `repo_impl::move_datacards_to_root(profile_id, folder_id)`
5. Permanently delete the folder row:

   * `repo_impl::purge_folder(profile_id, folder_id)`
6. Return `true`

**delete_folder_and_cards**

1. Require logged in
2. Load folder; reject system folder
3. Read settings `soft_delete_enabled` (same place you already read for cards)
4. If `soft_delete_enabled == true`:

   * `repo_impl::soft_delete_datacards_in_folder(profile_id, folder_id)`
     Else:
   * `repo_impl::purge_datacards_in_folder(profile_id, folder_id)`
5. Permanently delete folder:

   * `repo_impl::purge_folder(profile_id, folder_id)`
6. Return `true`

> Важно: сначала карточки (move/delete), потом delete folder, чтобы не словить FK/логические хвосты.

---

### 1.3 Repo layer: add “move cards to root” function

#### File: `src-tauri/src/data/sqlite/repo_impl.rs`

Add:

```rust
pub fn move_datacards_to_root(profile_id: &str, folder_id: &str) -> Result<bool> {
    let conn = open_connection(profile_id)?;
    let now = Utc::now().to_rfc3339();
    conn.execute(
        "UPDATE datacards SET folder_id = NULL, updated_at = ?1 WHERE folder_id = ?2",
        params![now, folder_id],
    )
    .map_err(|_| ErrorCodeString::new("DB_QUERY_FAILED"))?;
    Ok(true)
}
```

No other behavior changes needed.

---

### 1.4 Commands: remove deleted-folders endpoints + add two delete commands

#### File: `src-tauri/src/commands/folders.rs`

**Remove (delete entirely):**

* `list_deleted_folders`
* `restore_folder`
* `purge_folder` (если он использовался только для “Deleted folders management”)
* любые команды, связанные с deleted folders UI

**Keep:**

* `list_folders`
* `create_folder`
* `rename_folder`
* `move_folder`

**Replace folder delete command**:

* Old `delete_folder(id)` must be removed or repurposed.

**Add commands** (async + spawn_blocking pattern как у тебя сейчас):

```rust
#[tauri::command]
pub async fn delete_folder_only(id: String, state: State<'_, Arc<AppState>>) -> Result<bool>;

#[tauri::command]
pub async fn delete_folder_and_cards(id: String, state: State<'_, Arc<AppState>>) -> Result<bool>;
```

Both must:

* extract `let app = state.inner().clone();`
* `spawn_blocking(move || folders_service::delete_folder_only(id, &app))` etc.

---

### 1.5 main.rs: clean invoke handler

#### File: `src-tauri/src/main.rs`

In `invoke_handler![]`:

* Remove deleted folders commands you deleted
* Add:

  * `delete_folder_only`
  * `delete_folder_and_cards`

---

## 2) Frontend changes (React)

## 2.1 Remove deleted folders UI completely

### Files

* `src/features/Vault/components/Folders/Folders.tsx`
* `src/features/Vault/useVault.ts`
* `src/features/Vault/api/vaultApi.ts`
* `src/features/Vault/types/*` (если есть deleted folder types)

**Delete code paths**:

* Loading deleted folders list
* Rendering deleted folders in sidebar
* Any actions “restore folder / purge folder / list deleted folders”

**Result**:

* Sidebar shows only active folders.
* The “Deleted” navigation item remains ONLY for **deleted data cards** (cards trash).

---

## 2.2 Add “Delete folder” modal with two actions (when folder has cards)

### UI behavior

When user presses delete on a folder:

1. Determine how many cards are in that folder.
2. If count == 0 → delete immediately using **delete_folder_only** (no modal).
3. If count > 0 → open modal with:

* Title: **Delete folder**
* Text: `This folder contains {N} data cards. What do you want to do?`
* Buttons:

  * **Delete folder only** (cards will be moved to All)
  * **Delete folder and cards**
  * Cancel

### Where to compute “N”

**Use frontend state (mandatory)**:
In `useVault.ts`, you already hold active cards summary in memory. Compute:

```ts
const count = cards.filter(c => c.folderId === folderId).length
```

(Не добавляем backend count-команду.)

---

## 2.3 API: add two new invokes

#### File: `src/features/Vault/api/vaultApi.ts`

Add:

```ts
export async function deleteFolderOnly(id: string): Promise<boolean> {
  return invoke('delete_folder_only', { id });
}

export async function deleteFolderAndCards(id: string): Promise<boolean> {
  return invoke('delete_folder_and_cards', { id });
}
```

Remove any functions:

* `listDeletedFolders`
* `restoreFolder`
* `purgeFolder`
* anything for deleted folders.

---

## 2.4 Vault state updates (no full refresh)

#### File: `src/features/Vault/useVault.ts`

Add actions:

### deleteFolderOnlyAction(folderId)

1. Call `vaultApi.deleteFolderOnly(folderId)`
2. Update state:

* remove folder from `folders`
* for cards that were in folder: set `folderId = null` (root/All)
* if currently selected folder is deleted one → switch selection to `All`

### deleteFolderAndCardsAction(folderId)

1. Call `vaultApi.deleteFolderAndCards(folderId)`
2. Update state:

* remove folder from `folders`
* remove cards from `cards` where `folderId === folderId`
* if `settings.softDeleteEnabled === true` AND trash list already loaded:

  * append those cards into `deletedCards` (with deletedAt from backend? если нет — просто вызвать `refreshTrash()` один раз после операции)
* selection fix:

  * if selected folder was deleted → select `All`
  * if selected card was in that folder → clear selected card

**Разрешено**: после `delete_folder_and_cards` сделать **один** `refreshTrash()` (только если сейчас открыт Deleted или trashLoaded === true), чтобы deletedAt значения были корректными. `refreshActive()` вызывать нельзя.

---

## 2.5 Modal component

### File

Create new component:

`src/features/Vault/components/modals/DeleteFolderModal.tsx`

Uses the canonical dialog layout classes you уже ввели (UI-POLISH-VAULT-02):

* `.dialog`, `.dialog-header`, `.dialog-body`, `.dialog-footer`
* Buttons: `btn btn-secondary`, `btn btn-danger` (если есть) / `btn btn-primary` (если danger стиля нет)

Modal props:

```ts
type Props = {
  open: boolean;
  folderName: string;
  cardsCount: number;
  onCancel: () => void;
  onDeleteFolderOnly: () => void;
  onDeleteFolderAndCards: () => void;
}
```

---

## 3) i18n strings (mandatory)

Add keys (English):

### File

`src/i18n/English/Vault.json` (или где у тебя Vault strings)

Add:

* `vault.delete_folder.title`: `"Delete folder"`
* `vault.delete_folder.contains_cards`: `"This folder contains {{count}} data cards. What do you want to do?"`
* `vault.delete_folder.only`: `"Delete folder only"`
* `vault.delete_folder.and_cards`: `"Delete folder and cards"`
* `common.cancel`: `"Cancel"` (если ещё нет)

Frontend must not hardcode these texts.

---

## 4) Acceptance criteria

1. **No deleted folders UI** exists anywhere (no list/restore/purge for folders).
2. Clicking delete on an empty folder deletes it permanently with no modal.
3. Clicking delete on a folder with cards opens modal with two choices:

   * **Delete folder only**: folder removed, all cards moved to All (folderId=null)
   * **Delete folder and cards**: folder removed; cards deleted (soft delete respects `soft_delete_enabled`, otherwise purged)
4. No `refreshActive()` is triggered by folder deletion.
5. Build passes and no unused code remains for deleted folders commands/UI.

---
