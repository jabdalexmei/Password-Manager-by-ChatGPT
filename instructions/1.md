

## Technical Specification (EN): Fix 2FA (TOTP) UI integration + React Hooks crash

### Scope / Context

Project: Password Manager (Vite + React + Tauri).
Goal: Fix current regressions so that:

1. “Add 2FA” is available from the **action bar (⋯)** in **both** Create Data Card modal and Edit Data Card modal.
2. Adding 2FA via **text OR uploaded QR image** persists `totpUri` into the card and shows a TOTP code in **Details → Information**.
3. Fix the runtime crash in `Details` caused by violating React Hooks rules (“Rendered more hooks than during the previous render”). React requires hooks to be called unconditionally and before any early returns. ([React][1])

---

## Bug 1 — Crash: “Rendered more hooks than during the previous render” in Details

### Symptoms

App crashes when opening/selecting a card. Browser log shows:

* “React has detected a change in the order of Hooks called by Details…”
* “Uncaught Error: Rendered more hooks than during the previous render.”


### Root Cause

`useMemo` for `totpData` is currently executed **after** an early `if (!card) return ...;` path, meaning the hook call graph differs between renders (when `card` is null vs non-null). This violates the Rules of Hooks. ([React][1])

### Fix Requirements

**File:** `src/features/Vault/components/Details/Details.tsx`

1. Move `totpData` `useMemo` **above** the `if (!card) return ...;` early return.
2. Ensure the memo works safely when `card` is `null`:

   * Use `card?.totpUri` inside the memo.
   * Dependencies must be stable: `[card?.totpUri, totpNow]`.
3. Keep existing rendering logic: only show the TOTP UI block when `card?.totpUri` exists.

### Exact Code Change (replace / relocate block)

Locate the current block (currently after the `if (!card) return ...`):

```ts
const totpData = useMemo(() => {
  if (!card.totpUri) return null;

  try {
    return generateTotpCode(card.totpUri, totpNow);
  } catch {
    return null;
  }
}, [card.totpUri, totpNow]);
```

Relocate it so it appears **before**:

```ts
if (!card) {
  return ( ... );
}
```

And change it to null-safe version:

```ts
const totpData = useMemo(() => {
  const uri = card?.totpUri;
  if (!uri) return null;

  try {
    return generateTotpCode(uri, totpNow);
  } catch {
    return null;
  }
}, [card?.totpUri, totpNow]);
```

### Acceptance Criteria

* Selecting a card does not crash.
* No “Rendered more hooks…” warnings/errors in console.
* Details view works whether `card` is null (empty prompt) or non-null.

---

## Bug 2 — “Add 2FA” missing from Create Data Card action bar menu

### Symptoms

In **Create data card** modal, action bar menu (⋯) does not show “Add 2FA”.

### Root Cause

In `DataCards.tsx`, the 2FA action is gated behind `dialogId === 'datacard-edit-dialog'` (Edit-only), and the modal state is wired to `editForm` only.

### Fix Requirements

**File:** `src/features/Vault/components/DataCards/DataCards.tsx`

1. Show the “Add 2FA / Edit 2FA” menu item in action menu for **both**:

   * `datacard-create-dialog`
   * `datacard-edit-dialog`
2. When user clicks the menu item, open `Add2FAModal` and bind it to the correct target form:

   * Create dialog → `viewModel.createForm` and `viewModel.updateCreateField('totpUri', ...)`
   * Edit dialog → `viewModel.editForm` and `viewModel.updateEditField('totpUri', ...)`
3. Ensure `Add2FAModal` receives correct `existingUri`:

   * Create: `viewModel.createForm.totpUri` (or null if empty)
   * Edit: `viewModel.editForm?.totpUri` (or null if empty)
4. Ensure `defaults` passed into normalize are based on the active form (title fallback logic is OK).

### Implementation Details (exact approach)

Add a state to track which dialog opened the 2FA modal:

```ts
const [twoFactorTargetDialogId, setTwoFactorTargetDialogId] = useState<
  'datacard-create-dialog' | 'datacard-edit-dialog' | null
>(null);
```

**Action menu item** (remove edit-only condition; always render):

* Label must depend on current `form.totpUri` (the `form` param inside `renderDialog`):

```tsx
<button
  type="button"
  className="dialog-actionmenu-item"
  onClick={() => {
    setIsActionMenuOpen(false);
    setTwoFactorTargetDialogId(dialogId);
    setIs2faModalOpen(true);
  }}
>
  {form.totpUri?.trim() ? t('twoFactor.editAction') : t('twoFactor.addAction')}
</button>
```

**Add2FAModal binding** must switch based on `twoFactorTargetDialogId`:

```tsx
<Add2FAModal
  isOpen={is2faModalOpen}
  existingUri={
    twoFactorTargetDialogId === 'datacard-create-dialog'
      ? (viewModel.createForm.totpUri.trim() ? viewModel.createForm.totpUri : null)
      : (viewModel.editForm?.totpUri?.trim() ? viewModel.editForm.totpUri : null)
  }
  defaults={{
    issuer:
      twoFactorTargetDialogId === 'datacard-create-dialog'
        ? ((viewModel.createForm.title ?? 'Vault').trim() || 'Vault')
        : ((viewModel.editForm?.title ?? 'Vault').trim() || 'Vault'),
    label:
      twoFactorTargetDialogId === 'datacard-create-dialog'
        ? ((viewModel.createForm.title ?? 'Account').trim() || 'Account')
        : ((viewModel.editForm?.title ?? 'Account').trim() || 'Account'),
  }}
  onCancel={() => {
    setIs2faModalOpen(false);
    setTwoFactorTargetDialogId(null);
  }}
  onSave={(uri) => {
    if (twoFactorTargetDialogId === 'datacard-create-dialog') {
      viewModel.updateCreateField('totpUri', uri);
    } else {
      viewModel.updateEditField('totpUri', uri);
    }
    setIs2faModalOpen(false);
    setTwoFactorTargetDialogId(null);
  }}
  onRemove={() => {
    if (twoFactorTargetDialogId === 'datacard-create-dialog') {
      viewModel.updateCreateField('totpUri', '');
    } else {
      viewModel.updateEditField('totpUri', '');
    }
    setIs2faModalOpen(false);
    setTwoFactorTargetDialogId(null);
  }}
/>
```

### Notes on QR decoding

Current implementation uses `@zxing/browser` with `decodeFromImageUrl`, which is correct for decoding QR from an uploaded file blob URL. ([GitHub][2])

### Acceptance Criteria

* In Create dialog, action bar menu contains “Add 2FA”.
* Adding a Base32 secret or `otpauth://` works; saving persists it.
* Uploading QR image works; decoded URI is set into the form; saving persists it.

---

## Bug 3 — Action menu toggle is unreliable due to stale state usage

### Symptoms

Clicking ⋯ sometimes fails to toggle correctly, especially when switching between dialogs.

### Root Cause

The handler does:

1. `setCustomFieldTargetDialogId(dialogId);`
2. Immediately uses `customFieldTargetDialogId` (old value) to decide toggle

This uses **stale state** (React state updates are async).

### Fix Requirements

**File:** `src/features/Vault/components/DataCards/DataCards.tsx`

Change the ⋯ click handler to compute `isSameDialog` **before** setting the new target id:

```ts
onClick={() => {
  const isSameDialog = customFieldTargetDialogId === dialogId;
  setCustomFieldTargetDialogId(dialogId);
  setIsActionMenuOpen((prev) => (isSameDialog ? !prev : true));
}}
```

### Acceptance Criteria

* Clicking ⋯ reliably opens/closes the action menu.
* Switching between Create and Edit modals does not break menu behavior.

---

## Bug 4 — Escape key should close 2FA modal (and cleanup target state)

### Requirements

**File:** `src/features/Vault/components/DataCards/DataCards.tsx`

In your existing `keydown` handler (Escape logic), add:

```ts
if (is2faModalOpen) {
  setIs2faModalOpen(false);
  setTwoFactorTargetDialogId(null);
  return;
}
```

Also ensure your modal close/reset effect clears both `is2faModalOpen` and `twoFactorTargetDialogId` when dialogs close.

### Acceptance Criteria

* ESC closes the 2FA modal first (before closing parent dialog), without leaving dirty state.

---

## Verification Checklist (Manual)

1. `npm run dev` → open app → select no card → no crash.
2. Create Data Card:

   * Open Create modal
   * ⋯ → Add 2FA
   * Paste Base32 secret → Save → Create card
   * Card list shows “2FA” pill (if implemented)
   * Open card → Details shows live TOTP code with countdown; copy works (copied as secret).
3. Create Data Card with QR:

   * ⋯ → Add 2FA → QR tab → upload QR image → auto-switch to text with normalized `otpauth://...` → Save → Create → verify in Details.
4. Edit existing Data Card:

   * ⋯ → Edit 2FA, remove, save → verify removed.
5. Press ESC in:

   * Action menu open → closes menu
   * 2FA modal open → closes 2FA modal
   * Create/Edit modal open → closes dialog


