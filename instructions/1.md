## Technical Specification (EN): Workspace (Data Folder) Picker + Default Path Option (Windows, Tauri v2)

### 0. Summary

Implement an Obsidian-like **Workspace (Data Folder) picker** that is shown **on every app launch**, with:

* a left-side list of **all** previously created/added workspaces
* a **Create** button that either:

  * opens a directory picker; or
  * creates/uses a workspace in a **default path** near the executable when “Use default path” is enabled
* an **Open data folder** button to open the active workspace directory in Windows Explorer

All real data must be stored under:
`<WORKSPACE_ROOT>\Profiles\<PROFILE_ID>\...`

No automatic migration and no default workspace creation unless user explicitly chooses it (or ticks “Use default path”).

References:

* Tauri v2 dialog plugin `open({ directory: true, multiple: false })` usage and semantics. ([Tauri][1])
* Tauri v2 opener plugin can open/reveal paths in OS file explorer. ([Tauri][2])

---

## 1. Goals

1. Always show Workspace screen on startup.
2. Allow user to create/select a workspace folder and keep all app data inside it:

   * `<WORKSPACE_ROOT>\Profiles\...` (profiles and their per-profile storage)
3. Persist a list of **all workspaces** created/added (not “recent”).
4. Provide a “Use default path” checkbox:

   * when enabled, “Create” creates/uses workspace at `<APP_DIR>\Password Manager Vault` (see §4.3)
5. If no workspace is selected, any command requiring filesystem paths must return `WORKSPACE_NOT_SELECTED`.

---

## 2. Non-goals

* No migrations of existing profiles/vaults (dev mode).
* No auto-move of data.
* No cloud features.

---

## 3. Folder Layout (Authoritative)

### 3.1 Workspace root

User-selected folder:

* Example: `D:\Password Manager Vault\`

Inside workspace root:

* `.pm-workspace.json` (marker file)
* `Profiles\` (mandatory)

### 3.2 Profile-scoped storage (keep existing structure)

Under:
`<WORKSPACE_ROOT>\Profiles\<PROFILE_ID>\`

Keep current per-profile layout from the existing codebase (do not redesign):

* `vault.db` / `vault.db.enc` (whatever current profile implementation uses)
* `attachments\...`
* `backups\...`
* `tmp\...`
* `config.json`, `user_settings.json`, `kdf_salt.bin`, `key_check.bin`, etc. (as currently implemented in `src-tauri/src/data/profiles/paths.rs`)

**Rule:** Only change the root `profiles_root` to be derived from workspace root. All other per-profile path helpers remain conceptually the same.

---

## 4. Workspace Picker UX (Frontend)

### 4.1 Startup behavior

On every app launch, show `Workspace` screen first (no auto-forward), even if an active workspace exists:

* If a previously active workspace exists and is valid, it should be **preselected** in the list (highlighted), but the app remains on Workspace screen until the user explicitly selects/opens it.

### 4.2 Left panel: Workspace list (all workspaces)

Display all entries from workspace registry (see §5):

* `display_name` (folder name)
* full resolved path (secondary line)
* status badge:

  * `Missing` if folder doesn’t exist
  * `Invalid` if folder exists but marker file missing

Item actions:

* **Open/Select**: sets active workspace and proceeds to existing Startup flow.
* Context menu:

  * **Remove from list** (does not delete files on disk)

### 4.3 Main panel controls

Controls and behavior:

1. Checkbox: `Use default path`

* Default state: **unchecked**
* When checked, `Create` must not open directory picker.

2. Button: `Create`

* If `Use default path` is unchecked:

  * Open directory picker using `@tauri-apps/plugin-dialog`:

    * `open({ directory: true, multiple: false, title: "Choose data folder" })` ([Tauri][1])
  * When a path is returned:

    * call backend command `workspace_create({ path, mode: "create_or_open" })`
* If `Use default path` is checked:

  * Call backend command `workspace_create_default()`
  * Default workspace root: `<APP_DIR>\Password Manager Vault`
  * Same validation rules as normal create

3. Button: `Open data folder`

* Enabled only if an active workspace is selected and valid
* Calls backend `workspace_open_in_explorer()` to open the workspace root in Explorer (via plugin-opener `openPath`). ([Tauri][2])

### 4.4 Routing changes

`src/App.tsx` must include view state:

* `workspace` (always initial)
* `startup` (after successful workspace selection)

---

## 5. Workspace Registry (Persistence of “all workspaces” list)

### 5.1 Registry location

Primary path (portable-friendly):

* `<APP_DIR>\workspaces.json` where `APP_DIR = current_exe().parent()`

Fallback (only if APP_DIR is not writable):

* `%LOCALAPPDATA%\Password Manager\workspaces.json`

### 5.2 Registry JSON schema (exact)

```json
{
  "schema_version": 1,
  "active_workspace_id": "uuid-or-null",
  "workspaces": [
    {
      "id": "uuid",
      "display_name": "Password Manager Vault",
      "path": {
        "kind": "relative_to_app_dir",
        "value": "Password Manager Vault"
      }
    },
    {
      "id": "uuid",
      "display_name": "MyVault",
      "path": {
        "kind": "absolute",
        "value": "D:\\Password Manager Vault"
      }
    }
  ]
}
```

### 5.3 Path encoding rules

When saving an entry:

* If `workspace_root` is inside `APP_DIR`, store it as:

  * `kind = "relative_to_app_dir"`
  * `value = <relative path>`
* Otherwise store:

  * `kind = "absolute"`
  * `value = <absolute path>`

When resolving an entry:

* `relative_to_app_dir` resolves to `APP_DIR.join(value)`
* `absolute` resolves to `PathBuf::from(value)`

### 5.4 Workspace marker file

Inside workspace root:

* `<WORKSPACE_ROOT>\.pm-workspace.json`
  Content:

```json
{ "schema_version": 1 }
```

A folder is a “valid workspace” iff marker exists and `Profiles\` exists (or can be created).

---

## 6. Error codes (Backend)

Add error codes as `ErrorCodeString`:

* `WORKSPACE_NOT_SELECTED`
* `WORKSPACE_REGISTRY_READ_FAILED`
* `WORKSPACE_REGISTRY_WRITE_FAILED`
* `WORKSPACE_FOLDER_MISSING`
* `WORKSPACE_NOT_WRITABLE`
* `WORKSPACE_INVALID_MARKER`
* `WORKSPACE_PROFILES_CREATE_FAILED`

---

## 7. Backend API (Tauri commands)

### 7.1 New commands file

Create:

* `src-tauri/src/commands/workspace.rs`

Add commands:

#### (1) `workspace_list`

```rust
#[tauri::command]
pub fn workspace_list(state: tauri::State<'_, std::sync::Arc<crate::app_state::AppState>>)
  -> crate::error::Result<Vec<crate::types::WorkspaceItem>>;
```

Returns all registry entries with resolved path and status fields:

* `id: String`
* `display_name: String`
* `path: String` (resolved absolute)
* `exists: bool`
* `valid: bool`
* `is_active: bool`

#### (2) `workspace_select`

```rust
#[tauri::command]
pub fn workspace_select(
  id: String,
  state: tauri::State<'_, std::sync::Arc<crate::app_state::AppState>>
) -> crate::error::Result<bool>;
```

Behavior:

* Load registry, find `id`, resolve path.
* Validate folder exists, marker exists.
* Configure AppState workspace root (see §8).
* Set `active_workspace_id = id`, save registry.
* Return `true`.

#### (3) `workspace_create`

```rust
#[tauri::command]
pub fn workspace_create(
  path: String,
  state: tauri::State<'_, std::sync::Arc<crate::app_state::AppState>>
) -> crate::error::Result<bool>;
```

Behavior:

* Treat `path` as workspace root.
* Ensure directory exists (create if missing).
* Ensure marker file exists (create if missing).
* Ensure `<root>\Profiles` exists (create if missing).
* Upsert workspace entry in registry, set active.
* Configure AppState workspace root.
* Save registry.
* Return `true`.

#### (4) `workspace_create_default`

```rust
#[tauri::command]
pub fn workspace_create_default(
  state: tauri::State<'_, std::sync::Arc<crate::app_state::AppState>>
) -> crate::error::Result<bool>;
```

Behavior:

* Default root = `APP_DIR.join("Password Manager Vault")`
* Then same steps as `workspace_create`.

#### (5) `workspace_remove`

```rust
#[tauri::command]
pub fn workspace_remove(
  id: String,
  state: tauri::State<'_, std::sync::Arc<crate::app_state::AppState>>
) -> crate::error::Result<bool>;
```

Behavior:

* Remove from registry list.
* If removed workspace was active:

  * set `active_workspace_id = null`
  * clear AppState workspace selection (see §8.3)
* Save registry.
* Return `true`.

#### (6) `workspace_open_in_explorer`

```rust
#[tauri::command]
pub fn workspace_open_in_explorer(
  state: tauri::State<'_, std::sync::Arc<crate::app_state::AppState>>
) -> crate::error::Result<bool>;
```

Behavior:

* Requires selected workspace root, else `WORKSPACE_NOT_SELECTED`
* Open folder using plugin-opener JS is preferable; however this command may also invoke OS open on Rust side if you keep it backend-only.
* If implemented in Rust, must use `std::process::Command::new("explorer").arg(<path>)...` (Windows-only).
* Return `true`.

**Note:** If you choose to open from frontend, still keep backend validation for selected workspace. The Tauri v2 opener plugin supports opening paths with system default app / explorer. ([Tauri][2])

---

## 8. AppState + StoragePaths refactor (Workspace-aware)

### 8.1 AppState changes

Modify:

* `src-tauri/src/app_state.rs`

Requirements:

* Store `storage_paths` as `Mutex<StoragePaths>` so it can be configured after user selection:

  * `pub storage_paths: std::sync::Mutex<crate::data::storage_paths::StoragePaths>`

Add methods:

```rust
impl AppState {
  pub fn set_workspace_root(&self, workspace_root: std::path::PathBuf) -> crate::error::Result<()>;
  pub fn clear_workspace_root(&self) -> crate::error::Result<()>;
  pub fn get_storage_paths(&self) -> crate::error::Result<crate::data::storage_paths::StoragePaths>;
}
```

Behavior:

* `set_workspace_root`:

  * calls `StoragePaths::configure_workspace(workspace_root)`
  * clears any active/login/vault connection state:

    * `active_profile = None`
    * `logged_in_profile = None`
    * `vault_keeper_conn = None`
    * `vault_db_uri = None`
    * `vault_key = None`
* `clear_workspace_root`:

  * unsets `workspace_root` and `profiles_root` in StoragePaths
  * clears the same security state
* `get_storage_paths`:

  * returns a clone only if workspace configured; otherwise returns `WORKSPACE_NOT_SELECTED`

### 8.2 StoragePaths changes

Modify:

* `src-tauri/src/data/storage_paths.rs`

Replace “always Data next to exe” behavior with workspace configuration:

Required fields:

* `app_dir: PathBuf` (always available)
* `workspace_root: Option<PathBuf>`
* `profiles_root: Option<PathBuf>`

Required methods:

```rust
impl StoragePaths {
  pub fn new_unconfigured() -> crate::error::Result<Self>;
  pub fn app_dir(&self) -> &std::path::Path;
  pub fn configure_workspace(&mut self, workspace_root: PathBuf) -> crate::error::Result<()>;
  pub fn clear_workspace(&mut self);
  pub fn workspace_root(&self) -> crate::error::Result<&PathBuf>;
  pub fn profiles_root(&self) -> crate::error::Result<&PathBuf>;
}
```

`configure_workspace` must:

* ensure marker exists (or let the workspace command ensure it before calling)
* ensure `<workspace_root>\Profiles` exists (create dir all)
* verify writability:

  * create and delete a file: `<workspace_root>\.pm-write-test.tmp`
  * if fails → `WORKSPACE_NOT_WRITABLE`

### 8.3 Enforce workspace selection across all services

All code paths that currently use `state.storage_paths.clone()` must switch to `state.get_storage_paths()?`.

Update call sites at least in:

* `src-tauri/src/commands/profiles.rs`
* `src-tauri/src/services/security_service.rs`
* `src-tauri/src/services/datacards_service.rs`
* `src-tauri/src/services/folders_service.rs`
* `src-tauri/src/services/attachments_service.rs`
* `src-tauri/src/services/settings_service.rs`
* `src-tauri/src/data/sqlite/repo_impl.rs`
* `src-tauri/src/data/profiles/paths.rs` (see §9)

If workspace not selected, commands return `WORKSPACE_NOT_SELECTED` and frontend stays on Workspace screen.

---

## 9. Profiles paths refactor to workspace root

Modify:

* `src-tauri/src/data/profiles/paths.rs`

Change `profiles_root` helper to be workspace-aware:

* it must read from `StoragePaths.profiles_root()` (which is `<workspace_root>\Profiles`)

All functions that build profile paths must now fail with `WORKSPACE_NOT_SELECTED` if called before workspace selection.

No other structural changes inside profile directories are required.

---

## 10. Frontend: exact file changes

### 10.1 New feature screen

Create:

* `src/features/Workspace/Workspace.tsx`
* `src/features/Workspace/useWorkspace.ts`
* `src/features/Workspace/workspace.css` (or existing styles approach)

### 10.2 Tauri bridge functions

Modify:

* `src/lib/tauri.ts`

Add:

```ts
export type WorkspaceItem = {
  id: string;
  display_name: string;
  path: string;
  exists: boolean;
  valid: boolean;
  is_active: boolean;
};

export function workspaceList(): Promise<WorkspaceItem[]> {
  return invoke('workspace_list');
}
export function workspaceSelect(id: string): Promise<boolean> {
  return invoke('workspace_select', { id });
}
export function workspaceCreate(path: string): Promise<boolean> {
  return invoke('workspace_create', { path });
}
export function workspaceCreateDefault(): Promise<boolean> {
  return invoke('workspace_create_default');
}
export function workspaceRemove(id: string): Promise<boolean> {
  return invoke('workspace_remove', { id });
}
export function workspaceOpenInExplorer(): Promise<boolean> {
  return invoke('workspace_open_in_explorer');
}
```

### 10.3 Directory picker usage

In `Workspace.tsx`:

* `import { open } from '@tauri-apps/plugin-dialog';` ([Tauri][1])
* On Create with default unchecked:

  * `const selected = await open({ directory: true, multiple: false, title: 'Choose data folder' });`
  * if `typeof selected === 'string'` → `await workspaceCreate(selected)`
* On Create with default checked:

  * `await workspaceCreateDefault()`

### 10.4 Always show workspace screen first

Modify:

* `src/App.tsx`

Required:

* Initial view is always `'workspace'`.
* Navigating to `'startup'` only happens after `workspaceSelect/workspaceCreate/...` success.

### 10.5 i18n keys

Add to English locale file (create if needed):

* `src/i18n/English/Workspace.json`

Keys:

* `chooseFolder`
* `create`
* `openDataFolder`
* `useDefaultPath`
* `missing`
* `invalid`
* `removeFromList`
* `open`

---

## 11. Acceptance Criteria

1. On every app launch, Workspace screen is shown.
2. `Create` with unchecked default path prompts folder selection and creates:

   * `<chosen>\.pm-workspace.json`
   * `<chosen>\Profiles\`
3. `Create` with checked default path creates/uses:

   * `<APP_DIR>\Password Manager Vault\` with marker and Profiles folder
4. Left list shows **all** workspaces from registry (not recent), supports Remove-from-list without deleting disk data.
5. If no workspace is selected, calling profile/vault/data commands returns `WORKSPACE_NOT_SELECTED`.
6. Open data folder opens current workspace root in Explorer. ([Tauri][2])
7. Relative paths in registry work after drive-letter changes when workspace is inside app folder (portable on flash drive).
