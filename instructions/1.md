

## Technical Specification (TS): Bank Cards — Restore UX, Expiry Formatting/Validation, Label Rename, Details UI Layout

### Scope

Frontend-only changes for **Bank Cards** feature:

* Keep navigation state on restore from **Bank Cards → Deleted**
* Implement **Expiry (MM/YY)** input formatting + validation in **Create/Edit dialogs**
* Rename label **“Expiry (MM/YY)” → “Expiry date”**
* Make **Bank card Details panel** layout/field sizing match provided screenshot (more compact + Expiry/CVC smaller)

### Non-goals

* No data migration (dev “breaking” approach is acceptable).
* No backend schema changes.
* No changes to Data Cards here.

---

## 1) Bugfix: Restore card should NOT navigate away from Bank Cards → Deleted

### Current behavior

When restoring a card while in `selectedNav === 'deleted'`, code forces navigation to `all` and opens the restored item.

### Required behavior

After restore from **Bank Cards → Deleted**, user stays in **Deleted** section.
The restored card disappears from the deleted list (expected). Details selection should not jump to another item.

### Implementation

**File:** `src/features/Vault/useBankCards.ts`
**Function:** `restoreCardAction`

#### Change

* Remove navigation change `setSelectedNav((nav) => (nav === 'deleted' ? 'all' : nav))`
* Do **not** auto-select the restored card (it’s no longer in deleted list).
* Do **not** call `loadCard(id)` after restore when in deleted view.

#### Patch (apply exactly)

```diff
diff --git a/src/features/Vault/useBankCards.ts b/src/features/Vault/useBankCards.ts
--- a/src/features/Vault/useBankCards.ts
+++ b/src/features/Vault/useBankCards.ts
@@ -262,7 +262,7 @@
   const restoreCardAction = useCallback(
     async (id: string) => {
       try {
         await restoreBankCard(id);
         setDeletedCards((prev) => prev.filter((card) => card.id !== id));
         setCards((prev) => {
           const restored = deletedCards.find((card) => card.id === id);
           if (!restored) return prev;
           const updated = { ...restored, deletedAt: null };
           return sortCardsWithSettings([...prev.filter((card) => card.id !== id), updated]);
         });
-        setSelectedNav((nav) => (nav === 'deleted' ? 'all' : nav));
-        setSelectedCardId(id);
-        await loadCard(id);
+        setSelectedCardId((prev) => (prev === id ? null : prev));
       } catch (err) {
         handleError(err);
       }
     },
-    [deletedCards, handleError, loadCard, sortCardsWithSettings]
+    [deletedCards, handleError, sortCardsWithSettings]
   );
```

### Acceptance criteria

* In **Bank Cards → Deleted**, click **Restore**:

  * section remains **Deleted**
  * restored card disappears from list
  * no jump to **All Items**
  * no blank-screen / crash

---

## 2) Create/Edit Bank Card: Expiry (MM/YY) auto-format + validation

### UX requirement

* User can type `1125` → field becomes `11/25` automatically.
* Ignore any non-numeric chars (people paste `11/25`, `11-25`, etc).
* Validation rules:

  * Optional field: empty is allowed.
  * If not empty: must match `MM/YY`, month must be `01..12`. ([Baymard Institute][1])

### Implementation overview

Do formatting centrally in ViewModel so it applies to both Create and Edit dialogs.

---

### 2.1 Add field-level errors (instead of one generic error under Title)

**File:** `src/features/Vault/components/BankCards/useBankCardsViewModel.ts`

#### Add types

```diff
diff --git a/src/features/Vault/components/BankCards/useBankCardsViewModel.ts b/src/features/Vault/components/BankCards/useBankCardsViewModel.ts
--- a/src/features/Vault/components/BankCards/useBankCardsViewModel.ts
+++ b/src/features/Vault/components/BankCards/useBankCardsViewModel.ts
@@ -1,6 +1,13 @@
 import { useCallback, useState } from 'react';
 import { useTranslation } from '../../../../lib/i18n';
 import { BankCardItem, BankCardSummary, CreateBankCardInput, UpdateBankCardInput } from '../../types/ui';
 
+export type BankCardFieldErrorKey = 'title' | 'expiryMmYy' | 'cvc';
+export type BankCardFieldErrors = Partial<Record<BankCardFieldErrorKey, string>>;
+
 export type BankCardFormState = {
   title: string;
   holder: string;
   number: string;
   expiryMmYy: string;
   cvc: string;
   note: string;
   tagsText: string;
 };
```

#### Add helpers: format + validate

```diff
@@
 const buildInitialForm = (): BankCardFormState => ({
   title: '',
   holder: '',
   number: '',
   expiryMmYy: '',
   cvc: '',
   note: '',
   tagsText: '',
 });
+
+const EXPIRY_RE = /^(0[1-9]|1[0-2])\/\d{2}$/;
+const CVC_RE = /^\d{3,4}$/;
+
+const formatExpiryMmYy = (raw: string) => {
+  const digits = raw.replace(/\D/g, '').slice(0, 4);
+  if (digits.length <= 2) return digits;
+  return `${digits.slice(0, 2)}/${digits.slice(2)}`;
+};
+
+const formatCvc = (raw: string) => raw.replace(/\D/g, '').slice(0, 4);
```

#### Replace generic createError/editError with field errors

```diff
@@
 export type BankCardsViewModel = {
@@
-  createError: string | null;
-  editError: string | null;
+  createErrors: BankCardFieldErrors;
+  editErrors: BankCardFieldErrors;
@@
 };
@@
   const [isCreateOpen, setCreateOpen] = useState(false);
   const [isEditOpen, setEditOpen] = useState(false);
-  const [createError, setCreateError] = useState<string | null>(null);
-  const [editError, setEditError] = useState<string | null>(null);
+  const [createErrors, setCreateErrors] = useState<BankCardFieldErrors>({});
+  const [editErrors, setEditErrors] = useState<BankCardFieldErrors>({});
@@
   const resetEditForm = useCallback(() => {
     setEditForm(null);
     setEditCardId(null);
-    setEditError(null);
+    setEditErrors({});
   }, []);
@@
   const openCreateModal = useCallback(() => {
     resetCreateForm();
-    setCreateError(null);
+    setCreateErrors({});
     setCreateOpen(true);
   }, [resetCreateForm]);
@@
   const closeCreateModal = useCallback(() => {
     setCreateOpen(false);
-    setCreateError(null);
+    setCreateErrors({});
     resetCreateForm();
   }, [resetCreateForm]);
@@
   const openEditModal = useCallback((card: BankCardItem) => {
@@
     setEditCardId(card.id);
-    setEditError(null);
+    setEditErrors({});
     setEditOpen(true);
   }, []);
```

#### Apply formatting in updateCreateField / updateEditField + clear field error on change

```diff
@@
-  const updateCreateField = useCallback((field: keyof BankCardFormState, value: string) => {
-    setCreateForm((prev) => ({ ...prev, [field]: value }));
-  }, []);
+  const updateCreateField = useCallback((field: keyof BankCardFormState, value: string) => {
+    const nextValue =
+      field === 'expiryMmYy' ? formatExpiryMmYy(value) : field === 'cvc' ? formatCvc(value) : value;
+    setCreateForm((prev) => ({ ...prev, [field]: nextValue }));
+    if (field === 'title' || field === 'expiryMmYy' || field === 'cvc') {
+      setCreateErrors((prev) => {
+        if (!prev[field]) return prev;
+        const next = { ...prev };
+        delete next[field];
+        return next;
+      });
+    }
+  }, []);
 
-  const updateEditField = useCallback((field: keyof BankCardFormState, value: string) => {
-    setEditForm((prev) => (prev ? { ...prev, [field]: value } : prev));
-  }, []);
+  const updateEditField = useCallback((field: keyof BankCardFormState, value: string) => {
+    const nextValue =
+      field === 'expiryMmYy' ? formatExpiryMmYy(value) : field === 'cvc' ? formatCvc(value) : value;
+    setEditForm((prev) => (prev ? { ...prev, [field]: nextValue } : prev));
+    if (field === 'title' || field === 'expiryMmYy' || field === 'cvc') {
+      setEditErrors((prev) => {
+        if (!prev[field]) return prev;
+        const next = { ...prev };
+        delete next[field];
+        return next;
+      });
+    }
+  }, []);
```

#### Validate on submitCreate / submitEdit

```diff
@@
   const submitCreate = useCallback(async () => {
     if (isCreateSubmitting) return;
-    setCreateError(null);
+    setCreateErrors({});
     const trimmedTitle = createForm.title.trim();
-    if (!trimmedTitle) {
-      setCreateError(t('validation.titleRequired'));
-      return;
-    }
+    const nextErrors: BankCardFieldErrors = {};
+    if (!trimmedTitle) nextErrors.title = t('validation.titleRequired');
+
+    const expiry = createForm.expiryMmYy.trim();
+    if (expiry.length > 0 && !EXPIRY_RE.test(expiry)) {
+      nextErrors.expiryMmYy = t('validation.expiryInvalid');
+    }
+
+    const cvc = createForm.cvc.trim();
+    if (cvc.length > 0 && !CVC_RE.test(cvc)) {
+      nextErrors.cvc = t('validation.cvcInvalid');
+    }
+
+    if (Object.keys(nextErrors).length > 0) {
+      setCreateErrors(nextErrors);
+      return;
+    }
@@
     try {
       await onCreateCard(buildCreateInput(createForm));
       setCreateOpen(false);
       resetCreateForm();
     } catch {
-      setCreateError(t('validation.titleRequired'));
+      setCreateErrors({ title: t('validation.titleRequired') });
     } finally {
       setIsCreateSubmitting(false);
     }
   }, [createForm, isCreateSubmitting, onCreateCard, resetCreateForm, t]);
@@
   const submitEdit = useCallback(async () => {
     if (isEditSubmitting || !editForm || !editCardId) return;
-    setEditError(null);
+    setEditErrors({});
     const trimmedTitle = editForm.title.trim();
-    if (!trimmedTitle) {
-      setEditError(t('validation.titleRequired'));
-      return;
-    }
+    const nextErrors: BankCardFieldErrors = {};
+    if (!trimmedTitle) nextErrors.title = t('validation.titleRequired');
+
+    const expiry = editForm.expiryMmYy.trim();
+    if (expiry.length > 0 && !EXPIRY_RE.test(expiry)) {
+      nextErrors.expiryMmYy = t('validation.expiryInvalid');
+    }
+
+    const cvc = editForm.cvc.trim();
+    if (cvc.length > 0 && !CVC_RE.test(cvc)) {
+      nextErrors.cvc = t('validation.cvcInvalid');
+    }
+
+    if (Object.keys(nextErrors).length > 0) {
+      setEditErrors(nextErrors);
+      return;
+    }
@@
     try {
       await onUpdateCard(buildUpdateInput(editForm, editCardId));
       setEditOpen(false);
       resetEditForm();
     } catch {
-      setEditError(t('validation.titleRequired'));
+      setEditErrors({ title: t('validation.titleRequired') });
     } finally {
       setIsEditSubmitting(false);
     }
   }, [editCardId, editForm, isEditSubmitting, onUpdateCard, resetEditForm, t]);
```

#### Update returned ViewModel shape

```diff
@@
   return {
@@
-    createError,
-    editError,
+    createErrors,
+    editErrors,
@@
   };
```

---

### 2.2 Render field-specific errors in dialog

**File:** `src/features/Vault/components/BankCards/BankCards.tsx`

#### Update imports

```diff
diff --git a/src/features/Vault/components/BankCards/BankCards.tsx b/src/features/Vault/components/BankCards/BankCards.tsx
--- a/src/features/Vault/components/BankCards/BankCards.tsx
+++ b/src/features/Vault/components/BankCards/BankCards.tsx
@@ -1,6 +1,6 @@
 import React, { useEffect, useRef } from 'react';
 import { useTranslation } from '../../../../lib/i18n';
-import { BankCardFormState, BankCardsViewModel } from './useBankCardsViewModel';
+import { BankCardFormState, BankCardsViewModel, BankCardFieldErrors } from './useBankCardsViewModel';
```

#### Change renderDialog signature and usage

```diff
@@
   const renderDialog = (
     title: string,
     form: BankCardFormState | null,
-    error: string | null,
+    errors: BankCardFieldErrors,
     onClose: () => void,
@@
     if (!form) return null;
@@
             <div className="form-field">
@@
               <input
@@
               />
-              {error && <div className="form-error">{error}</div>}
+              {errors.title && <div className="form-error">{errors.title}</div>}
             </div>
@@
             <div className="form-field">
@@
               <input
@@
               />
+              {errors.expiryMmYy && <div className="form-error">{errors.expiryMmYy}</div>}
             </div>
@@
             <div className="form-field">
@@
               <input
@@
               />
+              {errors.cvc && <div className="form-error">{errors.cvc}</div>}
             </div>
```

#### Update calls

```diff
@@
       {viewModel.isCreateOpen &&
         renderDialog(
           t('dialog.createTitle'),
           viewModel.createForm,
-          viewModel.createError,
+          viewModel.createErrors,
           viewModel.closeCreateModal,
@@
       {viewModel.isEditOpen &&
         renderDialog(
           t('dialog.editTitle'),
           viewModel.editForm,
-          viewModel.editError,
+          viewModel.editErrors,
           viewModel.closeEditModal,
```

### Acceptance criteria

* Typing `1125` in expiry becomes `11/25`.
* Letters/symbols are ignored (e.g. paste `11-25` → `11/25`).
* Invalid expiry (`1325`, `00/25`, `1/25`, `111`) blocks save and shows error under expiry field.
* Empty expiry allowed.
* Empty cvc allowed; cvc must be `3-4 digits` if present.

---

## 3) Rename label: “Expiry (MM/YY)” → “Expiry date”

**File:** `src/i18n/English/BankCards.json`

### Change

* Update label text only.
* Keep placeholder as `MM/YY` (so user knows the format).

```diff
diff --git a/src/i18n/English/BankCards.json b/src/i18n/English/BankCards.json
--- a/src/i18n/English/BankCards.json
+++ b/src/i18n/English/BankCards.json
@@
   "label": {
@@
-    "expiry": "Expiry (MM/YY)",
+    "expiry": "Expiry date",
     "expiryPlaceholder": "MM/YY",
@@
   },
+  "validation": {
+    "titleRequired": "Title is required.",
+    "expiryInvalid": "Expiry date must be in MM/YY format (01-12/YY).",
+    "cvcInvalid": "CVC/CVV must be 3 or 4 digits."
+  }
```

> Примечание: если `validation.titleRequired` уже есть в файле — не дублировать, а только добавить недостающие ключи.

---

## 4) Details UI: match screenshot + make fields more compact

### Requirements from screenshot

* Details card layout remains vertical list, but:

  * overall padding/field heights slightly smaller (“уменьшить поля”)
  * `Expiry` and `CVC/CVV` should appear as a **compact 2-column row** (not full-width stacked)

### Implementation

#### 4.1 Add bank-card specific wrapper class + grid row

**File:** `src/features/Vault/components/BankCards/BankCardDetails.tsx`

```diff
diff --git a/src/features/Vault/components/BankCards/BankCardDetails.tsx b/src/features/Vault/components/BankCards/BankCardDetails.tsx
--- a/src/features/Vault/components/BankCards/BankCardDetails.tsx
+++ b/src/features/Vault/components/BankCards/BankCardDetails.tsx
@@
-      <div className="vault-detail-card">
+      <div className="vault-detail-card bankcard-detail-card">
@@
-        <div className="detail-field-list">
+        <div className="detail-field-list">
@@
           <div className="detail-field">
             <div className="detail-label">{t('label.number')}</div>
             <div className="detail-value-box">
@@
             </div>
           </div>
 
-          <div className="detail-field">
-            <div className="detail-label">{t('label.expiry')}</div>
-            <div className="detail-value-box">
-              <div className="detail-value-text">{card.expiryMmYy || tCommon('value.empty')}</div>
-            </div>
-          </div>
-
-          <div className="detail-field">
-            <div className="detail-label">{t('label.cvc')}</div>
-            <div className="detail-value-box">
-              <div className="detail-value-text detail-value-text-monospace">{cvcValue}</div>
-              <div className="detail-value-actions">
-                <button
-                  type="button"
-                  className="icon-button"
-                  aria-label={tCommon('action.copy')}
-                  onClick={() => handleCopy(card.cvc, t('label.cvc'))}
-                >
-                  <Copy />
-                </button>
-                <button
-                  type="button"
-                  className="icon-button"
-                  aria-label={revealCvc ? tCommon('action.hide') : tCommon('action.show')}
-                  onClick={() => setRevealCvc((prev) => !prev)}
-                >
-                  {revealCvc ? <EyeOff /> : <Eye />}
-                </button>
-              </div>
-            </div>
-          </div>
+          <div className="bankcard-detail-grid">
+            <div className="detail-field">
+              <div className="detail-label">{t('label.expiry')}</div>
+              <div className="detail-value-box">
+                <div className="detail-value-text">{card.expiryMmYy || tCommon('value.empty')}</div>
+              </div>
+            </div>
+
+            <div className="detail-field">
+              <div className="detail-label">{t('label.cvc')}</div>
+              <div className="detail-value-box">
+                <div className="detail-value-text detail-value-text-monospace">{cvcValue}</div>
+                <div className="detail-value-actions">
+                  <button
+                    type="button"
+                    className="icon-button"
+                    aria-label={tCommon('action.copy')}
+                    onClick={() => handleCopy(card.cvc, t('label.cvc'))}
+                  >
+                    <Copy />
+                  </button>
+                  <button
+                    type="button"
+                    className="icon-button"
+                    aria-label={revealCvc ? tCommon('action.hide') : tCommon('action.show')}
+                    onClick={() => setRevealCvc((prev) => !prev)}
+                  >
+                    {revealCvc ? <EyeOff /> : <Eye />}
+                  </button>
+                </div>
+              </div>
+            </div>
+          </div>
```

#### 4.2 Add CSS overrides (compact sizing + 2-column grid)

**File:** `src/styles/screens/vault.css`
Append near the end of Details section (after `.icon-button` rules is fine):

```diff
diff --git a/src/styles/screens/vault.css b/src/styles/screens/vault.css
--- a/src/styles/screens/vault.css
+++ b/src/styles/screens/vault.css
@@
 .icon-button:hover {
   border-color: var(--focus-border-strong);
   background: var(--color-surface-3);
 }
+
+/* Bank card details: compact layout (match screenshot) */
+.bankcard-detail-card {
+  padding: 12px 14px;
+  gap: 10px;
+}
+
+.bankcard-detail-card .detail-field-list {
+  gap: 10px;
+}
+
+.bankcard-detail-card .detail-value-box {
+  min-height: 40px;
+  padding: 8px 10px;
+}
+
+.bankcard-detail-grid {
+  display: grid;
+  grid-template-columns: minmax(160px, 220px) minmax(240px, 1fr);
+  gap: 12px;
+  align-items: start;
+}
+
+@media (max-width: 900px) {
+  .bankcard-detail-grid {
+    grid-template-columns: 1fr;
+  }
+}
```

### Acceptance criteria

* Expiry and CVC are displayed on one row (2 columns) on desktop widths, stacked on narrow widths.
* Field boxes are visibly more compact (smaller padding/height) compared to previous.
* No visual regressions for Data Cards details (changes apply only inside `.bankcard-detail-card`).

---

## Quick test checklist (manual)

1. Create bank card with expiry typed as `1125` → saved as `11/25`.
2. Edit same card: change expiry digits, change cvc digits, save → no “Operation failed”.
3. Go to Bank Cards → Deleted, restore a card:

   * remain in Deleted
   * restored item disappears
4. Details panel layout matches screenshot intent (compact, expiry/cvc row).


